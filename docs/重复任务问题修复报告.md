# é‡å¤ä»»åŠ¡é—®é¢˜æ’æŸ¥ä¸ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°
æäº¤ä¸€ä¸ªä»»åŠ¡åï¼Œå‰ç«¯ä¼šå‡ºç°å¤šä¸ªç›¸åŒä»»åŠ¡çš„å±•ç¤ºã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### 1. ä¸»è¦åŸå› ï¼šTOS ä¸Šä¼ æµç¨‹ä¸­é‡å¤è°ƒç”¨ initUpload API

**é—®é¢˜ä½ç½®**ï¼š`components/UploadForm.tsx` çš„ `handleNewFlowUpload` å‡½æ•°

**é—®é¢˜æè¿°**ï¼š
åœ¨å¤§æ–‡ä»¶ä¸Šä¼ æµç¨‹ä¸­ï¼ˆä½¿ç”¨ TOS çš„ä¸‰æ­¥ä¸Šä¼ ï¼‰ï¼Œä»£ç å¯¹ master æ–‡ä»¶å’Œ include æ–‡ä»¶**åˆ†åˆ«è°ƒç”¨äº†ä¸¤æ¬¡** `initUpload` APIï¼š

```typescript
// ç¬¬ä¸€æ¬¡è°ƒç”¨ - master æ–‡ä»¶
const initData = await initUpload({
  filename: masterFile.name,
  file_type: "master",
  job_name: jobName.trim(),
  // ...
});

// ç¬¬äºŒæ¬¡è°ƒç”¨ - include æ–‡ä»¶  
const includeInitData = await initUpload({
  filename: `${includeFolderLabel || "include"}.zip`,
  file_type: "include",
  job_name: jobName.trim(),
  // ...
});
```

**åæœ**ï¼š
- å¦‚æœåç«¯çš„ `initUpload` æ¥å£åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆä¸€æ¬¡æäº¤ä¼šåˆ›å»º**ä¸¤ä¸ªä»»åŠ¡**
- å³ä½¿ job_name ç›¸åŒï¼Œå¦‚æœåç«¯æ²¡æœ‰åšå¹‚ç­‰æ€§å¤„ç†ï¼Œä¹Ÿä¼šç”Ÿæˆä¸åŒçš„ task_id

### 2. æ¬¡è¦é£é™©ï¼šç¼ºå°‘å»é‡ä¿æŠ¤

**é—®é¢˜ä½ç½®**ï¼š`components/TasksTable.tsx` çš„ `createRows` å‡½æ•°

**é—®é¢˜æè¿°**ï¼š
- åŸå§‹ä»£ç ç›´æ¥å°†åç«¯è¿”å›çš„ä»»åŠ¡åˆ—è¡¨è½¬æ¢ä¸ºè¡¨æ ¼è¡Œï¼Œæ²¡æœ‰ä»»ä½•å»é‡é€»è¾‘
- å¦‚æœåç«¯è¿”å›çš„ä»»åŠ¡åˆ—è¡¨ä¸­åŒ…å«é‡å¤çš„ task_idï¼Œå‰ç«¯ä¼šåŸæ ·å±•ç¤º

### 3. æ¬¡è¦é£é™©ï¼šç¼ºå°‘é‡å¤æäº¤ä¿æŠ¤

**é—®é¢˜ä½ç½®**ï¼š`components/UploadForm.tsx` çš„ `handleSubmit` å‡½æ•°

**é—®é¢˜æè¿°**ï¼š
- è™½ç„¶æŒ‰é’®æœ‰ `disabled={submitting}` å±æ€§ï¼Œä½†åœ¨æŸäº›æç«¯æƒ…å†µä¸‹ï¼ˆå¦‚å¿«é€ŸåŒå‡»ï¼‰ï¼Œå¯èƒ½ä¼šè§¦å‘å¹¶å‘æäº¤
- åŸå§‹ä»£ç åœ¨å‡½æ•°å¼€å§‹æ—¶æ²¡æœ‰ç«‹å³æ£€æŸ¥ `submitting` çŠ¶æ€

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šåœ¨ UploadForm.tsx ä¸­æ·»åŠ  task_id ä¸€è‡´æ€§æ£€æŸ¥

**ä½ç½®**ï¼š`handleNewFlowUpload` å‡½æ•°

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
// å¦‚æœæœ‰ include æ–‡ä»¶ï¼Œä½¿ç”¨åŒä¸€ä¸ª task_id è·å– include çš„ä¸Šä¼  URL
let includeUploadInfo: { object_key: string; upload_url: string } | undefined;
if (includeZip) {
  const includeInitData = await initUpload({
    filename: `${includeFolderLabel || "include"}.zip`,
    file_size: includeZip.size,
    file_type: "include",
    content_type: "application/zip",
    job_name: jobName.trim(),
    submitter: "ç”¨æˆ·",
  });

  // âœ… æ–°å¢ï¼šæ£€æŸ¥è¿”å›çš„ task_id æ˜¯å¦ä¸€è‡´
  if (includeInitData.task_id !== taskId) {
    console.warn(`è­¦å‘Šï¼šinclude æ–‡ä»¶è¿”å›äº†ä¸åŒçš„ task_id: ${includeInitData.task_id}ï¼Œé¢„æœŸ: ${taskId}`);
    // è¿™é‡Œå¯èƒ½éœ€è¦æ¸…ç†é‡å¤åˆ›å»ºçš„ä»»åŠ¡
  }

  includeUploadInfo = includeInitData.include_upload;
}
```

**æ•ˆæœ**ï¼š
- å½“æ£€æµ‹åˆ°ä¸åŒçš„ task_id æ—¶ï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Š
- æ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿå®šä½é—®é¢˜æ ¹æºï¼ˆåç«¯åˆ›å»ºäº†å¤šä¸ªä»»åŠ¡ï¼‰

### ä¿®å¤ 2ï¼šåœ¨ UploadForm.tsx ä¸­æ·»åŠ é‡å¤æäº¤ä¿æŠ¤

**ä½ç½®**ï¼š`handleSubmit` å‡½æ•°å¼€å§‹å¤„

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
  event.preventDefault();
  
  // âœ… æ–°å¢ï¼šé˜²æ­¢é‡å¤æäº¤
  if (submitting) {
    console.warn("ä»»åŠ¡æ­£åœ¨æäº¤ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
    return;
  }
  
  // ... åç»­é€»è¾‘
}
```

**æ•ˆæœ**ï¼š
- åœ¨å‡½æ•°æ‰§è¡Œçš„æœ€å¼€å§‹å°±æ£€æŸ¥ `submitting` çŠ¶æ€
- å³ä½¿ç”¨æˆ·å¿«é€Ÿå¤šæ¬¡ç‚¹å‡»æäº¤æŒ‰é’®ï¼Œä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡æäº¤

### ä¿®å¤ 3ï¼šåœ¨ TasksTable.tsx ä¸­æ·»åŠ ä»»åŠ¡å»é‡é€»è¾‘

**ä½ç½®**ï¼š`createRows` å‡½æ•°

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
function createRows(items: RawTask[]): TableTask[] {
  // âœ… æ–°å¢ï¼šä½¿ç”¨ Map æ¥å»é‡ï¼Œä¿ç•™æœ€æ–°çš„ä»»åŠ¡ï¼ˆåŸºäº created_at æ—¶é—´æˆ³ï¼‰
  const taskMap = new Map<string, RawTask>();
  let duplicateCount = 0;
  
  items.forEach((item) => {
    const existing = taskMap.get(item.task_id);
    if (!existing) {
      taskMap.set(item.task_id, item);
    } else {
      // æ£€æµ‹åˆ°é‡å¤ä»»åŠ¡
      duplicateCount++;
      console.warn(`æ£€æµ‹åˆ°é‡å¤ä»»åŠ¡ ID: ${item.task_id}ï¼Œå°†ä¿ç•™æœ€æ–°çš„ç‰ˆæœ¬`);
      
      // å¦‚æœå·²å­˜åœ¨ï¼Œä¿ç•™æ—¶é—´æˆ³æ›´æ–°çš„é‚£ä¸ª
      const existingTime = existing.created_at ?? 0;
      const newTime = item.created_at ?? 0;
      if (newTime > existingTime) {
        taskMap.set(item.task_id, item);
      }
    }
  });
  
  // å¦‚æœæ£€æµ‹åˆ°é‡å¤ï¼Œè®°å½•ç»Ÿè®¡ä¿¡æ¯
  if (duplicateCount > 0) {
    console.warn(`æ€»å…±æ£€æµ‹åˆ° ${duplicateCount} ä¸ªé‡å¤ä»»åŠ¡ï¼Œå·²è‡ªåŠ¨å»é‡ã€‚åŸå§‹ä»»åŠ¡æ•°ï¼š${items.length}ï¼Œå»é‡åï¼š${taskMap.size}`);
  }
  
  // å°†å»é‡åçš„ä»»åŠ¡è½¬æ¢ä¸º TableTask
  return Array.from(taskMap.values()).map((item) => {
    // ... è½¬æ¢é€»è¾‘
  });
}
```

**æ•ˆæœ**ï¼š
- å³ä½¿åç«¯è¿”å›äº†é‡å¤çš„ä»»åŠ¡ï¼Œå‰ç«¯ä¹Ÿä¼šè‡ªåŠ¨å»é‡
- æŒ‰ç…§ task_id å»é‡ï¼Œä¿ç•™æœ€æ–°çš„ä»»åŠ¡ç‰ˆæœ¬ï¼ˆåŸºäº created_at æ—¶é—´æˆ³ï¼‰
- åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„å»é‡æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

## å»ºè®®çš„åç«¯ä¿®å¤æ–¹æ¡ˆ

è™½ç„¶å‰ç«¯å·²ç»æ·»åŠ äº†é˜²æŠ¤æªæ–½ï¼Œä½†**æ ¹æœ¬é—®é¢˜åº”è¯¥åœ¨åç«¯è§£å†³**ï¼š

### æ–¹æ¡ˆ Aï¼šä¼˜åŒ– initUpload æ¥å£ï¼ˆæ¨èï¼‰

**å»ºè®®**ï¼šä¿®æ”¹ `initUpload` æ¥å£ï¼Œæ”¯æŒä¸€æ¬¡æ€§åˆå§‹åŒ– master å’Œ include ä¸¤ä¸ªæ–‡ä»¶çš„ä¸Šä¼ ï¼š

```python
# æ¥å£è¯·æ±‚ç¤ºä¾‹
{
  "job_name": "task_001",
  "files": [
    {
      "filename": "master.speos",
      "file_size": 1024000,
      "file_type": "master",
      "content_type": "application/octet-stream"
    },
    {
      "filename": "include.zip",
      "file_size": 2048000,
      "file_type": "include",
      "content_type": "application/zip"
    }
  ]
}

# æ¥å£å“åº”ç¤ºä¾‹
{
  "task_id": "task_xxx",
  "master_upload": {
    "object_key": "...",
    "upload_url": "..."
  },
  "include_upload": {
    "object_key": "...",
    "upload_url": "..."
  }
}
```

**ä¼˜ç‚¹**ï¼š
- åªåˆ›å»ºä¸€ä¸ªä»»åŠ¡
- ä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰ä¸Šä¼  URL
- æ›´ç¬¦åˆä¸šåŠ¡é€»è¾‘

### æ–¹æ¡ˆ Bï¼šåŸºäº job_name çš„å¹‚ç­‰æ€§å¤„ç†

**å»ºè®®**ï¼šåœ¨ `initUpload` æ¥å£ä¸­ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸åŒçš„ job_nameï¼ˆæˆ–å…¶ä»–ä¸šåŠ¡æ ‡è¯†ï¼‰ï¼Œè¿”å›å·²å­˜åœ¨çš„ä»»åŠ¡ï¼š

```python
def init_upload(request):
    job_name = request.job_name
    file_type = request.file_type
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒ job_name çš„ä»»åŠ¡æ­£åœ¨åˆå§‹åŒ–
    existing_task = get_pending_task_by_job_name(job_name)
    
    if existing_task:
        # å¦‚æœæ˜¯ include æ–‡ä»¶ä¸”ä»»åŠ¡å·²å­˜åœ¨ï¼Œæ·»åŠ  include ä¸Šä¼ ä¿¡æ¯
        if file_type == "include":
            add_include_upload_to_task(existing_task.task_id)
        # è¿”å›å·²å­˜åœ¨çš„ä»»åŠ¡
        return existing_task
    else:
        # åˆ›å»ºæ–°ä»»åŠ¡
        return create_new_task(request)
```

**ä¼˜ç‚¹**ï¼š
- ç¡®ä¿åŒä¸€ä¸ª job_name åªåˆ›å»ºä¸€ä¸ªä»»åŠ¡
- å‰ç«¯æ— éœ€ä¿®æ”¹è°ƒç”¨é€»è¾‘

### æ–¹æ¡ˆ Cï¼šä¼ é€’ task_id å‚æ•°

**å»ºè®®**ï¼šä¿®æ”¹ `initUpload` æ¥å£ï¼Œæ”¯æŒä¼ é€’å·²å­˜åœ¨çš„ task_idï¼š

```python
# include æ–‡ä»¶çš„ initUpload è¯·æ±‚
{
  "task_id": "task_xxx",  // ä½¿ç”¨ master æ–‡ä»¶åˆ›å»ºçš„ task_id
  "filename": "include.zip",
  "file_type": "include",
  // ...
}
```

## éªŒè¯æ–¹æ³•

ä¿®å¤åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

1. **å‰ç«¯æ—¥å¿—éªŒè¯**ï¼š
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Console
   - æäº¤ä¸€ä¸ªå¸¦æœ‰ include æ–‡ä»¶çš„ä»»åŠ¡ï¼ˆæ–‡ä»¶å¤§å° > 50MBï¼Œè§¦å‘ TOS ä¸Šä¼ ï¼‰
   - è§‚å¯Ÿæ˜¯å¦å‡ºç°è­¦å‘Šæ—¥å¿—ï¼š
     - `è­¦å‘Šï¼šinclude æ–‡ä»¶è¿”å›äº†ä¸åŒçš„ task_id: xxxï¼Œé¢„æœŸ: xxx`
     - `æ£€æµ‹åˆ°é‡å¤ä»»åŠ¡ ID: xxxï¼Œå°†ä¿ç•™æœ€æ–°çš„ç‰ˆæœ¬`

2. **åç«¯æ—¥å¿—éªŒè¯**ï¼š
   - æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ `initUpload` æ¥å£è¢«è°ƒç”¨çš„æ¬¡æ•°
   - æ£€æŸ¥æ•°æ®åº“ï¼Œç¡®è®¤åªåˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡

3. **UI éªŒè¯**ï¼š
   - æäº¤ä»»åŠ¡åï¼Œæ£€æŸ¥ä»»åŠ¡åˆ—è¡¨
   - ç¡®è®¤åªæ˜¾ç¤ºä¸€ä¸ªä»»åŠ¡ï¼Œæ²¡æœ‰é‡å¤

## æ€»ç»“

- âœ… **å‰ç«¯å·²å®Œæˆé˜²æŠ¤æ€§ä¿®å¤**ï¼šæ·»åŠ äº†å»é‡ã€æ—¥å¿—å’Œé‡å¤æäº¤ä¿æŠ¤
- âš ï¸ **å»ºè®®ä¿®å¤åç«¯**ï¼šåœ¨ `initUpload` æ¥å£å®ç°å¹‚ç­‰æ€§ï¼Œé¿å…åˆ›å»ºé‡å¤ä»»åŠ¡
- ğŸ“Š **å¯è§‚æµ‹æ€§æå‡**ï¼šé€šè¿‡æ§åˆ¶å°æ—¥å¿—ï¼Œå¯ä»¥å¿«é€Ÿå‘ç°å’Œå®šä½é‡å¤ä»»åŠ¡é—®é¢˜

---

**ä¿®æ”¹æ–‡ä»¶æ¸…å•**ï¼š
- `components/UploadForm.tsx`
- `components/TasksTable.tsx`

**æµ‹è¯•å»ºè®®**ï¼š
1. æµ‹è¯•å°æ–‡ä»¶ä¸Šä¼ ï¼ˆæ—§æµç¨‹ï¼‰- åº”è¯¥æ­£å¸¸å·¥ä½œ
2. æµ‹è¯•å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆTOS æµç¨‹ï¼‰- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ä»»åŠ¡
3. æµ‹è¯•å¿«é€ŸåŒå‡»æäº¤æŒ‰é’® - åº”è¯¥åªæäº¤ä¸€æ¬¡
4. æµ‹è¯•åç«¯è¿”å›é‡å¤ä»»åŠ¡ - å‰ç«¯åº”è¯¥è‡ªåŠ¨å»é‡

**æ—¥æœŸ**ï¼š2025-11-04

