# 状态显示问题修复报告

## 问题描述

用户报告了两个前端状态显示问题：

1. **上传历史显示"上传中"**：任务已经提交并上传完成，但上传历史中状态仍然显示"上传中"
2. **绿色提示框显示过时状态**：任务提交成功后，绿色提示框显示"当前状态：PENDING"，但实际任务已经完成（在任务列表中显示为"SUCCESS"）

## 根本原因分析

### 问题 1：上传历史状态不更新

**原因**：
- 在 `finally` 块中，`currentUploadIdRef.current` 被设置为 `null`
- 虽然理论上状态更新应该在 `finally` 之前完成，但在某些边界情况下（如异步操作、React 批量更新等），可能导致竞态条件
- 使用 `currentUploadIdRef.current` 作为闭包变量时，如果它被提前清空，状态更新可能失败

**潜在的竞态条件**：
```typescript
// 在 handleOldFlowUpload 中
setUploadHistory((prev) =>
  prev.map((item) =>
    item.id === currentUploadIdRef.current  // ⚠️ 如果这时 currentUploadIdRef 被清空...
      ? { ...item, status: "success" }
      : item
  )
);

// 同时在 finally 块中
currentUploadIdRef.current = null;  // ❌ 可能导致上面的更新失败
```

### 问题 2：绿色提示框显示过时状态

**原因**：
- `submitInfo` 保存的是任务**提交时返回的初始状态**（通常是 "PENDING"）
- 这是一个静态快照，不会自动更新
- 任务列表每 5 秒刷新一次，会从后端获取最新状态
- 但绿色提示框的 `submitInfo` 永远不会更新，导致显示过时信息

**时间线**：
```
T=0s:   提交任务 → 后端返回 status="PENDING"
        → submitInfo 保存 {taskId: "xxx", status: "PENDING"}
        → 绿色提示框显示 "当前状态：PENDING" ❌

T=5s:   任务列表自动刷新 → 后端返回 status="SUCCESS"
        → 任务列表显示 "SUCCESS" ✅
        → 但绿色提示框仍然显示 "PENDING" ❌

T=39s:  任务实际完成
        → 任务列表显示 "SUCCESS" ✅
        → 绿色提示框仍然显示 "PENDING" ❌ (用户困惑)
```

## 修复方案

### 修复 1：使用局部变量保存上传 ID

**修改位置**：`components/UploadForm.tsx`

**修改前**：
```typescript
// 更新历史记录为成功
if (currentUploadIdRef.current) {
  setUploadHistory((prev) =>
    prev.map((item) =>
      item.id === currentUploadIdRef.current  // ⚠️ 可能被清空
        ? { ...item, status: "success", progress: 100, taskId: result.task_id }
        : item
    )
  );
}
```

**修改后**：
```typescript
// 更新历史记录为成功（使用局部变量保存引用，避免竞态条件）
const uploadId = currentUploadIdRef.current;
if (uploadId) {
  setUploadHistory((prev) =>
    prev.map((item) =>
      item.id === uploadId  // ✅ 使用局部变量，不受 finally 块影响
        ? { ...item, status: "success", progress: 100, taskId: result.task_id }
        : item
    )
  );
  console.log(`✅ 上传历史已更新为成功，任务ID: ${result.task_id}, 上传ID: ${uploadId}`);
}
```

**效果**：
- 使用局部变量 `uploadId` 保存引用，避免被 `finally` 块清空
- 添加日志输出，方便调试
- 两个上传流程（旧流程和 TOS 流程）都进行了修复

### 修复 2：自动隐藏绿色提示框

**修改位置**：`components/UploadForm.tsx`

**修改前**：
```typescript
setSubmitInfo({
  taskId: result.task_id,
  status: result.status,  // ❌ 静态状态，不会更新
  message: result.message ?? null,
});
```

**修改后**：
```typescript
setSubmitInfo({
  taskId: result.task_id,
  status: result.status,
  message: result.message ?? null,
});

// ✅ 3秒后自动隐藏成功提示，让用户关注任务列表中的实时状态
setTimeout(() => {
  setSubmitInfo(null);
}, 3000);
```

**效果**：
- 提示框显示 3 秒后自动消失
- 引导用户关注任务列表中的实时状态
- 避免过时状态造成用户困惑

### 修复 3：优化提示信息文案

**修改位置**：`components/UploadForm.tsx`

**修改前**：
```typescript
<p>
  任务提交成功，任务 ID：
  <span className="font-mono">{submitInfo.taskId}</span>
  {submitInfo.status && <span className="ml-2">当前状态：{submitInfo.status}</span>}  // ❌ 显示过时状态
</p>
<p className="mt-1 text-xs text-green-600">可在右侧任务列表中查看进度并下载结果。</p>
```

**修改后**：
```typescript
<p>
  ✅ 任务提交成功！任务 ID：
  <span className="font-mono font-semibold">{submitInfo.taskId}</span>
  {/* ✅ 移除了过时的状态显示 */}
</p>
{submitInfo.message && <p className="mt-1 text-xs text-green-600">{submitInfo.message}</p>}
<p className="mt-1 text-xs text-green-600">
  📋 请在下方任务列表中查看实时状态和下载结果
</p>
```

**效果**：
- 移除了误导性的"当前状态"显示
- 明确引导用户查看任务列表获取实时状态
- 改进了文案和视觉效果

## 测试验证

### 测试场景 1：验证上传历史状态更新

**步骤**：
1. 打开浏览器开发者工具 Console
2. 提交一个任务
3. 观察控制台输出

**预期结果**：
```
✅ 上传历史已更新为成功，任务ID: 99fd584e-55b1-4441-9c05-cd467e092d1e, 上传ID: upload_1730736840000
```

**预期 UI 表现**：
- 上传历史中的状态应该从"上传中"变为"成功"（绿色标签）
- 显示任务 ID
- 进度条显示 100%

### 测试场景 2：验证绿色提示框自动消失

**步骤**：
1. 提交一个任务
2. 观察绿色提示框
3. 等待 3 秒

**预期结果**：
- 提交成功后，立即显示绿色提示框
- 提示框显示任务 ID，但**不显示状态**
- 3 秒后提示框自动消失
- 用户可以在任务列表中看到实时状态（PENDING → STARTED → SUCCESS）

### 测试场景 3：验证任务列表显示实时状态

**步骤**：
1. 提交一个任务
2. 观察任务列表（自动每 5 秒刷新）
3. 等待任务完成

**预期结果**：
- 任务列表中的状态会实时更新：PENDING → STARTED → SUCCESS
- 状态更新时间戳会显示最新的时间
- 任务完成后显示执行时长和下载链接

## 代码变更清单

### 修改的文件

- `components/UploadForm.tsx`

### 变更摘要

1. **行 504-514**：旧流程上传 - 使用局部变量保存上传 ID，添加日志
2. **行 521-525**：旧流程上传 - 添加自动隐藏提示框逻辑
3. **行 650-660**：TOS 流程上传 - 使用局部变量保存上传 ID，添加日志
4. **行 665-671**：TOS 流程上传 - 添加自动隐藏提示框逻辑
5. **行 1038-1048**：优化提示信息文案，移除过时状态显示

## 后续改进建议

### 1. 持久化上传历史（可选）

**问题**：用户刷新页面后，上传历史会丢失

**建议**：
```typescript
// 保存上传历史到 localStorage
useEffect(() => {
  if (uploadHistory.length > 0) {
    localStorage.setItem('upload_history', JSON.stringify(uploadHistory));
  }
}, [uploadHistory]);

// 页面加载时恢复上传历史
useEffect(() => {
  const saved = localStorage.getItem('upload_history');
  if (saved) {
    setUploadHistory(JSON.parse(saved));
  }
}, []);
```

### 2. 添加任务状态变化通知（可选）

**建议**：当任务从 PENDING 变为 SUCCESS 时，显示浏览器通知或页面通知

```typescript
// 在 TasksTable.tsx 中
useEffect(() => {
  baseRows.forEach((task) => {
    if (task.status === "SUCCESS" && !notifiedTasks.has(task.task_id)) {
      // 显示通知
      if (Notification.permission === "granted") {
        new Notification("任务完成", {
          body: `${task.job_name} 已完成`,
        });
      }
      setNotifiedTasks(prev => new Set([...prev, task.task_id]));
    }
  });
}, [baseRows]);
```

### 3. 后端 API 优化建议

**当前问题**：前端需要通过轮询（每 5 秒）获取任务状态

**建议**：实现 WebSocket 或 Server-Sent Events (SSE) 推送任务状态更新

**优点**：
- 实时更新，无延迟
- 减少服务器负载（不需要频繁轮询）
- 更好的用户体验

**示例**：
```python
# 后端实现 SSE
@app.get("/tasks/{task_id}/events")
async def task_events(task_id: str):
    async def event_generator():
        while True:
            task = get_task(task_id)
            yield f"data: {json.dumps({'status': task.status})}\n\n"
            if task.status in ["SUCCESS", "FAILURE"]:
                break
            await asyncio.sleep(1)
    
    return EventSourceResponse(event_generator())
```

```typescript
// 前端使用 EventSource
const eventSource = new EventSource(`${API_BASE}/tasks/${taskId}/events`);
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  updateTaskStatus(taskId, data.status);
};
```

## 总结

### 修复的问题

✅ 上传历史状态不更新 → 使用局部变量避免竞态条件  
✅ 绿色提示框显示过时状态 → 3秒后自动隐藏，引导用户查看任务列表  
✅ 误导性的状态显示 → 移除静态状态，优化文案  

### 用户体验改进

- 🎯 明确的状态反馈：上传历史正确显示"成功"状态
- ⏱️ 及时的信息清理：过时的提示 3 秒后自动消失
- 📋 清晰的引导：提示用户在任务列表查看实时状态
- 🔍 更好的可调试性：添加日志输出，方便排查问题

### 无需后端修改

所有修复都在前端完成，不需要修改后端代码。

---

**修复日期**：2025-11-04  
**修复文件**：`components/UploadForm.tsx`  
**测试状态**：通过 Linter 检查

