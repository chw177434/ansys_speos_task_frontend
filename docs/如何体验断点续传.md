# 如何体验断点续传功能

## 🎯 快速演示（5分钟）

### 准备工作

1. **创建测试文件**（20MB）
   ```bash
   # Windows PowerShell
   fsutil file createnew test_20mb.zip 20971520
   
   # 或者 macOS/Linux
   dd if=/dev/zero of=test_20mb.zip bs=1M count=20
   ```

2. **打开浏览器开发者工具**
   - 按 F12
   - 切换到 **Console** 标签

### 步骤 1：首次上传（正常完成）

1. 访问 http://localhost:3000/tools/speos
2. 填写表单：
   - Profile Name: `test`
   - Version: `v1`
   - Job Name: `断点续传测试`
3. 选择刚创建的 `test_20mb.zip`
4. 点击"提交任务"

**观察点**：
- ✅ 看到提示：`📦 使用断点续传模式`
- ✅ 看到分片信息：`📦 分片上传模式 X/4 片`
- ✅ 控制台日志：
  ```
  🚀 初始化分片上传: test_20mb.zip (20 MB)
  ✅ 初始化成功: taskId=xxx, uploadId=yyy, 总分片=4
  ⬆️ 上传分片 1/4 (5 MB)
  ✅ 分片 1 上传成功, ETag=abc, 速度=2.5 MB/s
  ✅ 保存上传进度: test_20mb.zip, 已上传 1/4 片
  ...
  ```

### 步骤 2：中断上传（关键！）

1. **重新上传**相同文件
2. **等待上传到第 2 片时**（看到 `⬆️ 上传分片 2/4`）
3. **立即关闭浏览器标签页**（Ctrl+W 或点击 X）

**此时**：
- localStorage 已保存：片 1-2 的进度
- 服务器已接收：片 1-2 的数据

### 步骤 3：恢复上传（见证奇迹！）

1. **重新打开** http://localhost:3000/tools/speos
2. 打开 Console
3. **执行以下命令查看保存的进度**：
   ```javascript
   Object.keys(localStorage)
     .filter(k => k.startsWith('resumable_upload'))
     .forEach(k => {
       const data = JSON.parse(localStorage.getItem(k));
       console.log(`✅ 发现断点续传进度:`, data);
       console.log(`   文件: ${data.filename}`);
       console.log(`   已上传: ${data.uploaded_parts.length}/${data.total_chunks} 片`);
     });
   ```

4. 填写**相同的表单信息**：
   - Profile Name: `test`
   - Version: `v1`
   - Job Name: `断点续传测试`（必须相同！）
5. 选择**相同的文件** `test_20mb.zip`
6. 点击"提交任务"

**观察点（断点续传生效！）**：
```
✅ 控制台显示：
📥 加载上传进度: test_20mb.zip, 已上传 2/4 片
📊 服务器记录显示已上传 2 片，跳过这些分片
⏭️ 跳过已上传的分片 1/4
⏭️ 跳过已上传的分片 2/4
⬆️ 上传分片 3/4 (5 MB)  ← 从这里继续！
✅ 分片 3 上传成功
⬆️ 上传分片 4/4 (5 MB)
✅ 分片 4 上传成功
✅ 所有分片上传完成 (4/4)
🏁 完成上传，合并所有分片...
```

**对比**：
- ❌ 如果没有断点续传：需要重新上传 4 片（20MB）
- ✅ 有断点续传：只上传剩余 2 片（10MB）
- 💡 **节省了 50% 的时间和流量！**

---

## 🔍 验证断点续传是否生效

### 方法 1：查看控制台日志

**关键日志**：
```javascript
// 有这些日志 = 断点续传生效
📥 加载上传进度: xxx.zip, 已上传 X/Y 片
⏭️ 跳过已上传的分片 1/Y
⏭️ 跳过已上传的分片 2/Y
```

**没有这些日志**：
- 可能是文件太小（< 10MB）
- 或者 Job Name 不一致
- 或者 localStorage 被清除

### 方法 2：查看 localStorage

**打开控制台执行**：
```javascript
// 查看所有断点续传记录
for (let key of Object.keys(localStorage)) {
  if (key.startsWith('resumable_upload')) {
    console.log('📦 断点续传记录:', key);
    console.log(JSON.parse(localStorage.getItem(key)));
  }
}
```

**有数据 = 功能正常**：
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "object_key": "speos_tasks/...",
  "filename": "test_20mb.zip",
  "file_size": 20971520,
  "total_chunks": 4,
  "uploaded_parts": [
    {"part_number": 1, "etag": "abc123"},
    {"part_number": 2, "etag": "def456"}
  ],
  "timestamp": 1699999999999
}
```

### 方法 3：查看网络请求

**F12 → Network 标签**：

1. **首次上传**时会看到：
   ```
   POST /api/tasks/upload/multipart/init
   PUT https://tos-cn-beijing.volces.com/... (分片1)
   PUT https://tos-cn-beijing.volces.com/... (分片2)
   PUT https://tos-cn-beijing.volces.com/... (分片3)
   PUT https://tos-cn-beijing.volces.com/... (分片4)
   POST /api/tasks/upload/multipart/complete
   ```

2. **恢复上传**时会看到：
   ```
   POST /api/tasks/upload/multipart/init
   POST /api/tasks/upload/multipart/list  ← 查询已上传分片
   PUT https://tos-cn-beijing.volces.com/... (分片3) ← 只上传剩余的
   PUT https://tos-cn-beijing.volces.com/... (分片4)
   POST /api/tasks/upload/multipart/complete
   ```

---

## 📏 文件大小与上传模式

| 文件大小 | 上传模式 | 是否有分片信息 |
|---------|---------|--------------|
| < 10 MB | 直接上传 | ❌ 不显示分片 |
| 10-50 MB | 断点续传 | ✅ 显示分片 |
| > 50 MB | 断点续传 | ✅ 显示分片 |

**如果你的文件 < 10MB**，不会触发断点续传！

---

## ⚠️ 常见问题

### Q1: 我上传了 20MB 文件，但没看到分片信息？

**检查清单**：
1. ✅ 浏览器开发者工具是否打开？
2. ✅ 文件确实 >= 10MB？
3. ✅ 查看上传进度区域（不是历史记录）
4. ✅ 控制台是否有错误？

### Q2: 重新上传时没有跳过已上传分片？

**原因**：
1. Job Name 不一致 → task_id 不同
2. localStorage 被清除
3. 浏览器隐私模式（不保存 localStorage）

**解决**：
```javascript
// 检查是否有保存的进度
localStorage.getItem('resumable_upload_xxx_master')
// 如果返回 null，说明没有保存
```

### Q3: 想要清除测试数据重新开始

```javascript
// 清除所有断点续传记录
Object.keys(localStorage)
  .filter(k => k.startsWith('resumable_upload'))
  .forEach(k => localStorage.removeItem(k));

console.log('✅ 已清除所有断点续传记录，可以重新测试');
```

---

## 🎬 完整演示视频脚本

### 场景：上传 50MB 文件，中断后恢复

**第一幕：正常上传**
```
[打开页面]
"我要上传一个 50MB 的文件..."

[选择文件，点击提交]
"注意看，这里显示 '📦 使用断点续传模式'"
"分片信息：1/10, 2/10, 3/10..."

[上传到 5/10 时]
"现在我突然关闭浏览器..."
[关闭标签页]
```

**第二幕：恢复上传**
```
[重新打开页面]
"让我们看看 localStorage 里保存了什么..."

[控制台执行]
> localStorage.getItem('resumable_upload_xxx_master')
"看！已经保存了 5 个分片的进度！"

[填写相同表单，选择相同文件]
"现在重新上传相同的文件..."

[点击提交]
"神奇的事情发生了！"
"控制台显示：⏭️ 跳过已上传的分片 1/10...5/10"
"直接从第 6 片开始上传！"

[上传完成]
"成功！只用了一半的时间！"
```

---

## 🚀 进阶测试

### 测试 1：网络中断恢复

1. 开始上传 100MB 文件
2. F12 → Network → Offline（模拟断网）
3. 等待上传失败
4. 切换回 Online
5. 再次点击提交
6. 观察是否从断点继续

### 测试 2：多次中断

1. 上传 100MB 文件
2. 上传到 30% → 关闭浏览器
3. 重新上传 → 上传到 60% → 关闭浏览器
4. 重新上传 → 应该从 60% 继续
5. 完成

### 测试 3：取消后重新上传

1. 上传 50MB 文件
2. 上传到 50% → 点击"取消上传"
3. localStorage 应该被清除
4. 重新上传 → 应该从 0% 开始（不是断点续传）

---

## 💡 提示

1. **断点续传是自动的**：无需手动操作
2. **Job Name 很重要**：必须一致才能恢复
3. **文件要够大**：至少 10MB 才会启用
4. **打开控制台**：才能看到详细日志
5. **耐心等待**：大文件上传需要时间

---

**最后**：如果还是看不到效果，请提供：
- 文件大小
- 控制台日志截图
- localStorage 内容

