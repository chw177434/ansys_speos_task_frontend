# 测试重复任务修复指南

## 测试前准备

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 确保显示所有日志级别（包括 Warning）

## 测试场景

### 场景 1：小文件上传（旧流程，文件 < 50MB）

**目的**：验证旧流程不受影响

**步骤**：
1. 准备一个小于 50MB 的 master 文件
2. 填写表单信息（Profile Name, Version, Job Name）
3. 点击"提交任务"按钮
4. 观察控制台和任务列表

**预期结果**：
- ✅ 任务成功提交
- ✅ 任务列表中只出现一个任务
- ✅ 控制台没有重复任务的警告

### 场景 2：大文件上传（TOS 流程，文件 >= 50MB）

**目的**：验证 TOS 上传流程的重复任务问题

**步骤**：
1. 准备一个大于 50MB 的 master 文件（或 master + include 总大小 > 50MB）
2. 填写表单信息
3. 点击"提交任务"按钮
4. 观察上传进度
5. 等待任务提交完成
6. 检查控制台日志和任务列表

**预期结果（修复前）**：
- ❌ 可能出现两个相同的任务
- ❌ 控制台可能有警告：`警告：include 文件返回了不同的 task_id: xxx，预期: xxx`

**预期结果（修复后）**：
- ✅ 任务列表中只显示一个任务
- ⚠️ 如果后端仍然创建重复任务，控制台会显示警告，但前端会自动去重
- ✅ 任务可以正常执行

### 场景 3：快速重复点击提交按钮

**目的**：验证重复提交保护

**步骤**：
1. 准备一个测试文件
2. 填写表单信息
3. 快速多次点击"提交任务"按钮（双击或三击）
4. 观察控制台和任务列表

**预期结果**：
- ✅ 控制台显示：`任务正在提交中，请勿重复提交`
- ✅ 只创建一个任务
- ✅ 提交按钮在提交期间保持禁用状态

### 场景 4：后端返回重复任务（手动测试）

**目的**：验证前端的去重逻辑

**步骤**：
1. 如果可以控制后端，修改后端使其返回重复的任务
2. 或者，等待定时刷新（每 5 秒）观察
3. 检查任务列表

**预期结果**：
- ✅ 控制台显示去重警告：
  - `检测到重复任务 ID: xxx，将保留最新的版本`
  - `总共检测到 N 个重复任务，已自动去重。原始任务数：X，去重后：Y`
- ✅ 任务列表中只显示一个任务（即使后端返回多个）

## 控制台日志说明

### 正常日志

```
任务提交成功，任务 ID：task_xxx
```

### 警告日志（需要关注）

```
⚠️ 警告：include 文件返回了不同的 task_id: task_yyy，预期: task_xxx
→ 说明：后端在 initUpload 时创建了多个任务，需要修复后端
```

```
⚠️ 检测到重复任务 ID: task_xxx，将保留最新的版本
→ 说明：后端返回了重复的任务，前端已自动去重
```

```
⚠️ 总共检测到 2 个重复任务，已自动去重。原始任务数：3，去重后：1
→ 说明：后端返回的任务列表中有重复，前端已处理
```

```
⚠️ 任务正在提交中，请勿重复提交
→ 说明：用户尝试重复提交，已被阻止
```

## 如何判断是前端还是后端的问题

1. **如果控制台出现**: `警告：include 文件返回了不同的 task_id`
   - 🔴 **这是后端问题**
   - 后端的 `initUpload` 接口没有正确处理幂等性
   - 需要修复后端，让它识别同一个 job_name 并返回相同的 task_id

2. **如果控制台出现**: `检测到重复任务 ID`
   - 🔴 **这是后端问题**
   - 后端的 `/tasks` 列表接口返回了重复的任务
   - 前端已经做了容错处理，但根本问题在后端

3. **如果控制台出现**: `任务正在提交中，请勿重复提交`
   - 🟢 **这是正常的保护机制**
   - 说明前端的重复提交保护起作用了

## 数据库验证（可选）

如果有数据库访问权限，可以直接查询：

```sql
-- 查找重复的任务
SELECT job_name, COUNT(*) as count
FROM tasks
WHERE created_at > NOW() - INTERVAL 1 HOUR
GROUP BY job_name
HAVING COUNT(*) > 1;

-- 查看具体的重复任务
SELECT task_id, job_name, status, created_at
FROM tasks
WHERE job_name IN (
  SELECT job_name
  FROM tasks
  WHERE created_at > NOW() - INTERVAL 1 HOUR
  GROUP BY job_name
  HAVING COUNT(*) > 1
)
ORDER BY job_name, created_at;
```

## 修复验证清单

- [ ] 小文件上传正常，无重复任务
- [ ] 大文件上传正常，无重复任务
- [ ] 快速双击提交按钮，只提交一次
- [ ] 即使后端返回重复任务，前端也能正确去重
- [ ] 控制台日志清晰，便于定位问题

## 下一步

如果测试发现仍然有重复任务，请：

1. ✅ 确认前端代码已更新（检查文件修改时间）
2. ✅ 清除浏览器缓存并刷新页面
3. 📋 复制完整的控制台日志
4. 📋 记录复现步骤
5. 🔍 联系后端团队修复 `initUpload` 接口

---

**最后更新**：2025-11-04

