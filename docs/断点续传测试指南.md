# 断点续传测试指南

## 🚀 快速测试

### 准备工作

1. **启动后端服务**
```bash
# 确保后端服务运行在 http://localhost:8000
# 检查是否启动: 访问 http://localhost:8000/docs
```

2. **启动前端**
```bash
npm run dev
# 前端运行在 http://localhost:3000
```

3. **准备测试文件**
- 小文件：< 10MB（测试普通上传）
- 中等文件：10-50MB（测试断点续传）
- 大文件：> 50MB（测试断点续传 + 长时间上传）

## 📋 测试场景

### ✅ 场景 1：中等文件上传（基础测试）

**目标**：验证断点续传基本功能

**步骤**：
1. 准备一个 20MB 的文件
2. 打开浏览器开发者工具（F12）→ Console 标签
3. 填写表单信息（Profile Name, Version, Job Name）
4. 选择 Master File（20MB 文件）
5. 点击"提交任务"

**预期结果**：
```
✅ 控制台显示：
🚀 初始化分片上传: filename.zip (20 MB)
✅ 初始化成功: taskId=xxx, uploadId=yyy, 总分片=4
⬆️ 上传分片 1/4 (5 MB)
✅ 分片 1 上传成功, ETag=abc, 速度=2.5 MB/s
✅ 保存上传进度: filename.zip, 已上传 1/4 片
⬆️ 上传分片 2/4 (5 MB)
...
✅ 分片上传完成: filename.zip
```

```
✅ UI 显示：
📦 使用断点续传模式
━━━━━━━━━━━━━━━━ 75%

速度: 2.5 MB/s    剩余时间: 15 秒

📦 分片上传模式    3/4 片
当前分片: #3
```

```
✅ 任务列表显示：
新任务出现，状态为 PENDING 或 DOWNLOADING
```

---

### ✅ 场景 2：断点续传（核心测试）

**目标**：验证断点续传恢复功能

**步骤**：
1. 准备一个 50MB 的文件（10 片）
2. 打开控制台，填写表单，开始上传
3. **等待上传到第 5 片后**，关闭浏览器标签页
4. 重新打开页面
5. **选择相同的文件**，填写**相同的 Job Name**
6. 点击"提交任务"

**预期结果**：

**第一次上传（中断前）**：
```
⬆️ 上传分片 1/10
✅ 保存上传进度: filename.zip, 已上传 1/10 片
⬆️ 上传分片 2/10
✅ 保存上传进度: filename.zip, 已上传 2/10 片
...
⬆️ 上传分片 5/10
✅ 保存上传进度: filename.zip, 已上传 5/10 片
[关闭浏览器]
```

**第二次上传（恢复后）**：
```
📥 加载上传进度: filename.zip, 已上传 5/10 片
📊 服务器记录显示已上传 5 片，跳过这些分片
⏭️ 跳过已上传的分片 1/10
⏭️ 跳过已上传的分片 2/10
⏭️ 跳过已上传的分片 3/10
⏭️ 跳过已上传的分片 4/10
⏭️ 跳过已上传的分片 5/10
⬆️ 上传分片 6/10 (5 MB)  ← 从这里继续
✅ 分片 6 上传成功
...
✅ 所有分片上传完成 (10/10)
```

**检查 localStorage**：
```javascript
// 打开控制台执行
Object.keys(localStorage).filter(k => k.startsWith('resumable_upload'))
// 应该看到类似: ["resumable_upload_abc123_master"]

// 查看详情
JSON.parse(localStorage.getItem('resumable_upload_abc123_master'))
// 应该看到上传进度数据
```

---

### ✅ 场景 3：网络中断恢复

**目标**：验证网络错误后的恢复

**步骤**：
1. 准备 30MB 文件（6 片）
2. 开始上传
3. **等待上传到第 3 片时**，打开开发者工具
4. 切换到 Network 标签 → Offline（模拟断网）
5. 观察错误提示
6. 切换回 Online（恢复网络）
7. **再次点击提交**（相同文件、相同 Job Name）

**预期结果**：
```
[断网前]
✅ 分片 1 上传成功
✅ 分片 2 上传成功
✅ 分片 3 上传成功
⬆️ 上传分片 4/6
❌ 网络错误，分片上传失败

[恢复网络后]
📥 加载上传进度: filename.zip, 已上传 3/6 片
⏭️ 跳过已上传的分片 1/6
⏭️ 跳过已上传的分片 2/6
⏭️ 跳过已上传的分片 3/6
⬆️ 上传分片 4/6  ← 继续
✅ 完成
```

---

### ✅ 场景 4：取消上传

**目标**：验证取消功能

**步骤**：
1. 准备 100MB 文件（20 片）
2. 开始上传
3. **等待上传到第 10 片**
4. 点击"取消上传"按钮

**预期结果**：
```
✅ 控制台：
⬆️ 上传分片 10/20
🚫 上传已取消
🗑️ 清除上传进度: abc123 (master)
```

```
✅ UI：
- 进度条消失
- 按钮恢复为"提交任务"
```

```
✅ localStorage：
// 执行
localStorage.getItem('resumable_upload_abc123_master')
// 返回 null（已清除）
```

---

### ✅ 场景 5：包含 Include 文件

**目标**：验证 Master + Include 的断点续传

**步骤**：
1. 准备 Master 文件：30MB
2. 准备 Include 文件夹：20MB（多个文件）
3. 填写表单，选择 Master + Include
4. 上传到一半时关闭浏览器
5. 重新打开，再次上传

**预期结果**：
```
[第一次]
⬆️ 上传 Master 文件（分片模式）
✅ 分片 1/6
✅ 分片 2/6
✅ 分片 3/6
[关闭浏览器]

[第二次]
📥 加载上传进度: master.zip, 已上传 3/6 片
⏭️ 跳过已上传的分片 1/6, 2/6, 3/6
⬆️ 上传分片 4/6
...
✅ Master 文件上传完成
⬆️ 上传 Include 文件（分片模式）
✅ Include 文件上传完成
✅ 提交任务
```

---

## 🔍 调试技巧

### 1. 查看 localStorage

```javascript
// 查看所有断点续传记录
Object.keys(localStorage)
  .filter(k => k.startsWith('resumable_upload'))
  .forEach(k => {
    console.log(k, JSON.parse(localStorage.getItem(k)));
  });
```

### 2. 清理 localStorage（重新测试）

```javascript
// 清理所有断点续传记录
Object.keys(localStorage)
  .filter(k => k.startsWith('resumable_upload'))
  .forEach(k => localStorage.removeItem(k));

console.log('✅ 已清理所有断点续传记录');
```

### 3. 模拟慢速网络

**Chrome 开发者工具**：
1. F12 → Network 标签
2. 选择 "Slow 3G" 或 "Fast 3G"
3. 观察分片上传速度和进度

### 4. 查看网络请求

**查看 initMultipartUpload 请求**：
```
POST /api/tasks/upload/multipart/init

Request:
{
  "filename": "model.zip",
  "file_size": 20971520,
  "file_type": "master",
  "content_type": "application/zip",
  "chunk_size": 5242880
}

Response:
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "object_key": "speos_tasks/...",
  "total_chunks": 4,
  "parts": [
    {
      "part_number": 1,
      "upload_url": "https://...",
      "start_byte": 0,
      "end_byte": 5242880,
      "size": 5242880
    }
  ]
}
```

**查看 uploadPart 请求**：
```
PUT {part.upload_url}

Request Header:
Content-Type: application/octet-stream

Request Body:
[Binary Data - 5MB]

Response Header:
ETag: "abc123def456"  ← 重要！必须获取
```

**查看 completeMultipartUpload 请求**：
```
POST /api/tasks/upload/multipart/complete

Request:
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "object_key": "speos_tasks/...",
  "file_type": "master",
  "parts": [
    {"part_number": 1, "etag": "abc123"},
    {"part_number": 2, "etag": "def456"},
    {"part_number": 3, "etag": "ghi789"},
    {"part_number": 4, "etag": "jkl012"}
  ]
}
```

## ⚠️ 常见问题排查

### 问题 1：断点续传不生效

**症状**：重新上传时从头开始，不跳过已上传分片

**检查**：
```javascript
// 1. 检查 localStorage
localStorage.getItem('resumable_upload_xxx_master')
// 如果返回 null，说明没有保存进度

// 2. 检查控制台是否有错误
// 查找 "保存上传进度失败" 或其他错误

// 3. 检查 task_id 是否一致
// 第一次和第二次的 task_id 必须相同
```

**解决**：
- 确保浏览器允许 localStorage
- 检查隐私模式是否禁用了 localStorage
- 确保 Job Name 相同（影响 task_id 生成）

### 问题 2：ETag 错误

**症状**：completeMultipartUpload 时报错

**检查**：
```javascript
// 查看保存的 ETag
const progress = JSON.parse(localStorage.getItem('resumable_upload_xxx_master'));
console.log(progress.uploaded_parts);

// 检查 ETag 格式
// ✅ 正确: "abc123"
// ❌ 错误: ""abc123"" （多了引号）
```

**解决**：代码中已处理，确保使用最新代码

### 问题 3：分片顺序错误

**症状**：completeMultipartUpload 时报错 "Parts not in order"

**检查**：
```javascript
// 查看分片顺序
const progress = JSON.parse(localStorage.getItem('resumable_upload_xxx_master'));
console.log(progress.uploaded_parts.map(p => p.part_number));

// 应该是: [1, 2, 3, 4] ✅
// 不应该是: [2, 1, 4, 3] ❌
```

**解决**：代码中已自动排序，确保使用最新代码

### 问题 4：进度显示不准确

**症状**：进度条卡在某个百分比

**检查**：
- 打开控制台查看上传日志
- 检查网络请求是否正常
- 查看是否有错误提示

**解决**：
- 刷新页面重试
- 检查网络连接
- 查看后端服务是否正常

## 📊 性能测试

### 测试不同文件大小

| 文件大小 | 分片数 | 预计时间（100Mbps） | 模式 |
|---------|--------|-------------------|------|
| 5 MB | 1 | 0.4 秒 | 普通上传 |
| 10 MB | 2 | 0.8 秒 | 断点续传 |
| 50 MB | 10 | 4 秒 | 断点续传 |
| 100 MB | 20 | 8 秒 | 断点续传 |
| 500 MB | 100 | 40 秒 | 断点续传 |

### 断点续传效率测试

**场景**：100MB 文件，上传到 50% 中断

| 模式 | 总时间 | 浪费时间 | 效率 |
|------|--------|---------|------|
| 无断点续传 | 8s + 8s = 16s | 8s | 50% |
| 有断点续传 | 8s + 4s = 12s | 0s | 100% |

**节省**：(16s - 12s) / 16s = **25% 时间**

## ✅ 验收标准

完成以下所有测试即可确认功能正常：

- [ ] **场景 1**：中等文件上传成功
- [ ] **场景 2**：断点续传恢复成功
- [ ] **场景 3**：网络中断恢复成功
- [ ] **场景 4**：取消上传成功
- [ ] **场景 5**：Include 文件上传成功
- [ ] **UI 显示**：分片进度正确
- [ ] **控制台日志**：无错误，日志完整
- [ ] **localStorage**：进度保存和清除正常
- [ ] **任务列表**：任务正常创建
- [ ] **文件验证**：上传后文件完整无损

## 📝 测试报告模板

```markdown
## 断点续传测试报告

### 测试环境
- 浏览器：Chrome 120.0.0.0
- 操作系统：Windows 11
- 网络：100 Mbps
- 后端版本：v1.0.0
- 前端版本：v1.0.0

### 测试结果

#### 场景 1：中等文件上传
- 文件大小：20 MB
- 分片数：4
- 结果：✅ 成功
- 时间：1.6 秒
- 备注：无

#### 场景 2：断点续传
- 文件大小：50 MB
- 中断位置：第 5 片
- 恢复后跳过：5 片
- 结果：✅ 成功
- 备注：localStorage 正常工作

#### 场景 3：网络中断
- 文件大小：30 MB
- 中断位置：第 3 片
- 结果：✅ 成功
- 备注：恢复后正常继续

#### 场景 4：取消上传
- 文件大小：100 MB
- 取消位置：第 10 片
- 结果：✅ 成功
- 备注：localStorage 已清除

#### 场景 5：Include 文件
- Master：30 MB
- Include：20 MB
- 结果：✅ 成功
- 备注：两个文件都使用断点续传

### 总结
✅ 所有测试场景通过
✅ 断点续传功能正常
✅ UI 显示准确
✅ 性能符合预期
```

---

**测试日期**：2025-11-05  
**文档版本**：v1.0  
**相关文档**：
- [断点续传实现说明](./断点续传实现说明.md)
- [后端接口规范](./【给前端】断点续传接口规范.md)

