# å‰ç«¯æ¥å£è¯´æ˜ï¼šå‰©ä½™æ—¶é—´æ˜¾ç¤ºä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-01-XX  
**å½±å“èŒƒå›´**: å‰ç«¯éœ€è¦æ›´æ–° `estimated_time` å­—æ®µçš„è§£æå’Œæ˜¾ç¤ºé€»è¾‘  
**çŠ¶æ€**: âš ï¸ **å‰ç«¯éœ€è¦é…å¥—ä¿®æ”¹**

---

## ğŸ“‹ æ¥å£å˜æ›´è¯´æ˜

### API ç«¯ç‚¹

**æ¥å£**: `GET /api/tasks/{task_id}/detail`  
**å“åº”æ¨¡å‹**: `TaskDetail`

### å˜æ›´å­—æ®µ

**å­—æ®µ**: `progress_info.estimated_time`  
**ç±»å‹**: `string | null`  
**ä½ç½®**: `TaskDetail.progress_info.estimated_time`

---

## ğŸ”„ å˜æ›´å†…å®¹

### ä¿®å¤å‰ï¼ˆæ—§æ ¼å¼ï¼‰

`estimated_time` åªåŒ…å«ä»¥ä¸‹æ ¼å¼ï¼š

```typescript
// æ ¼å¼1: åªæœ‰å°æ—¶ï¼ˆæµ®ç‚¹æ•°ï¼‰
"14.0 hours"
"2.5 hours"

// æ ¼å¼2: åªæœ‰åˆ†é’Ÿï¼ˆæ•´æ•°ï¼‰
"19 minutes"
"45 minutes"
```

### ä¿®å¤åï¼ˆæ–°æ ¼å¼ï¼‰

`estimated_time` ç°åœ¨æ”¯æŒä»¥ä¸‹æ‰€æœ‰æ ¼å¼ï¼š

```typescript
// æ ¼å¼1: å¤© + å°æ—¶ï¼ˆæ–°å¢ï¼‰
"5 days 14 hours"
"3 days 2 hours"
"4 days 1 hours"  // æ³¨æ„ï¼šå•æ•° hour ä¹Ÿä¼šè¾“å‡ºä¸º hours

// æ ¼å¼2: å¤© + åˆ†é’Ÿï¼ˆæ–°å¢ï¼‰
"4 days 57 min"
"3 days 30 min"
"4 days 30 minutes"  // minutes ä¼šç®€åŒ–ä¸º min

// æ ¼å¼3: å¤© + å°æ—¶ + åˆ†é’Ÿï¼ˆæ–°å¢ï¼Œå½“åˆ†é’Ÿ >= 60 æ—¶è‡ªåŠ¨è½¬æ¢ï¼‰
"4 days 1 hours 30 min"  // ä¾‹å¦‚ï¼š4 days 90 min â†’ 4 days 1 hours 30 min

// æ ¼å¼4: åªæœ‰å¤©ï¼ˆæ–°å¢ï¼‰
"5 days"
"3 days"
"1 day"

// æ ¼å¼5: åªæœ‰å°æ—¶ï¼ˆä¿æŒä¸å˜ï¼‰
"14 hours"
"2 hours"

// æ ¼å¼6: åªæœ‰åˆ†é’Ÿï¼ˆä¿æŒä¸å˜ï¼‰
"19 minutes"
"45 minutes"
```

---

## ğŸ“ æ¥å£å“åº”ç¤ºä¾‹

### ç¤ºä¾‹ 1: é•¿æ—¶é—´ä»»åŠ¡ï¼ˆå¤©+å°æ—¶ï¼‰

```json
{
  "task_id": "abc123",
  "status": "RUNNING",
  "progress_info": {
    "estimated_time": "5 days 14 hours",
    "progress_percent": 0.2,
    "current_pass": 1,
    "total_passes": 110,
    "current_sensor": 1,
    "total_sensors": 1
  }
}
```

### ç¤ºä¾‹ 1b: é•¿æ—¶é—´ä»»åŠ¡ï¼ˆå¤©+åˆ†é’Ÿï¼‰

```json
{
  "task_id": "abc124",
  "status": "RUNNING",
  "progress_info": {
    "estimated_time": "4 days 57 min",
    "progress_percent": 0.3,
    "current_pass": 1,
    "total_passes": 110,
    "current_sensor": 1,
    "total_sensors": 1
  }
}
```

### ç¤ºä¾‹ 2: ä¸­ç­‰æ—¶é—´ä»»åŠ¡ï¼ˆåªæœ‰å°æ—¶ï¼‰

```json
{
  "task_id": "def456",
  "status": "RUNNING",
  "progress_info": {
    "estimated_time": "14 hours",
    "progress_percent": 41.4,
    "current_pass": 1,
    "total_passes": 2,
    "current_sensor": 1,
    "total_sensors": 1
  }
}
```

### ç¤ºä¾‹ 3: çŸ­æ—¶é—´ä»»åŠ¡ï¼ˆåªæœ‰åˆ†é’Ÿï¼‰

```json
{
  "task_id": "ghi789",
  "status": "RUNNING",
  "progress_info": {
    "estimated_time": "19 minutes",
    "progress_percent": 75.0,
    "current_pass": 2,
    "total_passes": 2,
    "current_sensor": 1,
    "total_sensors": 1
  }
}
```

---

## ğŸ’» å‰ç«¯å®ç°å»ºè®®

### TypeScript ç±»å‹å®šä¹‰

```typescript
interface ProgressInfo {
  estimated_time?: string | null;  // æ ¼å¼: "5 days 14 hours" | "14 hours" | "19 minutes"
  progress_percent?: number;       // 0-100
  current_pass?: number;
  total_passes?: number;
  current_sensor?: number;
  total_sensors?: number;
}

interface TaskDetail {
  task_id: string;
  status: string;
  progress_info?: ProgressInfo | null;
  // ... å…¶ä»–å­—æ®µ
}
```

### æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ¨èï¼‰

```typescript
/**
 * æ ¼å¼åŒ– estimated_time å­—ç¬¦ä¸²ä¸ºä¸­æ–‡æ˜¾ç¤º
 * @param estimatedTime åç«¯è¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ "5 days 14 hours"
 * @returns æ ¼å¼åŒ–åçš„ä¸­æ–‡æ—¶é—´å­—ç¬¦ä¸²
 */
function formatEstimatedTime(estimatedTime: string | null | undefined): string {
  if (!estimatedTime) {
    return "è®¡ç®—ä¸­...";
  }

  // åŒ¹é… "X days Y hours Z min" æˆ– "X days Y hours"
  const daysHoursMinMatch = estimatedTime.match(/(\d+)\s+days?\s+(\d+)\s+hours?(?:\s+(\d+)\s+min)?/i);
  if (daysHoursMinMatch) {
    const days = parseInt(daysHoursMinMatch[1]);
    const hours = parseInt(daysHoursMinMatch[2]);
    const minutes = daysHoursMinMatch[3] ? parseInt(daysHoursMinMatch[3]) : 0;
    if (minutes > 0) {
      return `${days}å¤©${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    }
    return `${days}å¤©${hours}å°æ—¶`;
  }

  // åŒ¹é… "X days Y min" æˆ– "X days Y minutes"
  const daysMinMatch = estimatedTime.match(/(\d+)\s+days?\s+(\d+)\s+min(?:utes)?/i);
  if (daysMinMatch) {
    const days = parseInt(daysMinMatch[1]);
    const minutes = parseInt(daysMinMatch[2]);
    if (minutes >= 60) {
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      if (remainingMinutes > 0) {
        return `${days}å¤©${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ`;
      }
      return `${days}å¤©${hours}å°æ—¶`;
    }
    return `${days}å¤©${minutes}åˆ†é’Ÿ`;
  }

  // åŒ¹é… "X days" æ ¼å¼ï¼ˆåªæœ‰å¤©ï¼‰
  const daysMatch = estimatedTime.match(/(\d+)\s+days?/i);
  if (daysMatch) {
    const days = parseInt(daysMatch[1]);
    return `${days}å¤©`;
  }

  // åŒ¹é… "X hours" æ ¼å¼ï¼ˆåªæœ‰å°æ—¶ï¼‰
  const hoursMatch = estimatedTime.match(/(\d+(?:\.\d+)?)\s+hours?/i);
  if (hoursMatch) {
    const hours = parseFloat(hoursMatch[1]);
    if (hours >= 1) {
      return `${Math.round(hours)}å°æ—¶`;
    } else {
      const minutes = Math.round(hours * 60);
      return `${minutes}åˆ†é’Ÿ`;
    }
  }

  // åŒ¹é… "X minutes" æ ¼å¼ï¼ˆåªæœ‰åˆ†é’Ÿï¼‰
  const minutesMatch = estimatedTime.match(/(\d+)\s+minutes?/i);
  if (minutesMatch) {
    const minutes = parseInt(minutesMatch[1]);
    return `${minutes}åˆ†é’Ÿ`;
  }

  // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œç›´æ¥è¿”å›åŸå­—ç¬¦ä¸²
  return estimatedTime;
}
```

### React ç»„ä»¶ç¤ºä¾‹

```tsx
import React from 'react';

interface TaskProgressProps {
  progressInfo?: {
    estimated_time?: string | null;
    progress_percent?: number;
    current_pass?: number;
    total_passes?: number;
  } | null;
}

const TaskProgress: React.FC<TaskProgressProps> = ({ progressInfo }) => {
  if (!progressInfo) {
    return <div>æš‚æ— è¿›åº¦ä¿¡æ¯</div>;
  }

  const formatEstimatedTime = (time: string | null | undefined): string => {
    if (!time) return "è®¡ç®—ä¸­...";
    
    // åŒ¹é… "X days Y hours"
    const daysHoursMatch = time.match(/(\d+)\s+days?\s+(\d+)\s+hours?/i);
    if (daysHoursMatch) {
      return `${daysHoursMatch[1]}å¤©${daysHoursMatch[2]}å°æ—¶`;
    }
    
    // åŒ¹é… "X days"
    const daysMatch = time.match(/(\d+)\s+days?/i);
    if (daysMatch) {
      return `${daysMatch[1]}å¤©`;
    }
    
    // åŒ¹é… "X hours"
    const hoursMatch = time.match(/(\d+(?:\.\d+)?)\s+hours?/i);
    if (hoursMatch) {
      const hours = parseFloat(hoursMatch[1]);
      return hours >= 1 ? `${Math.round(hours)}å°æ—¶` : `${Math.round(hours * 60)}åˆ†é’Ÿ`;
    }
    
    // åŒ¹é… "X minutes"
    const minutesMatch = time.match(/(\d+)\s+minutes?/i);
    if (minutesMatch) {
      return `${minutesMatch[1]}åˆ†é’Ÿ`;
    }
    
    return time;
  };

  return (
    <div className="task-progress">
      {progressInfo.progress_percent !== undefined && (
        <div>
          <span>è¿›åº¦: {progressInfo.progress_percent.toFixed(1)}%</span>
        </div>
      )}
      
      {progressInfo.estimated_time && (
        <div>
          <span>å‰©ä½™æ—¶é—´: {formatEstimatedTime(progressInfo.estimated_time)}</span>
        </div>
      )}
      
      {progressInfo.current_pass !== undefined && progressInfo.total_passes !== undefined && (
        <div>
          <span>Pass: {progressInfo.current_pass}/{progressInfo.total_passes}</span>
        </div>
      )}
    </div>
  );
};

export default TaskProgress;
```

### æµ‹è¯•ç”¨ä¾‹

```typescript
// æµ‹è¯•ç”¨ä¾‹
describe('formatEstimatedTime', () => {
  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "5 days 14 hours"', () => {
    expect(formatEstimatedTime('5 days 14 hours')).toBe('5å¤©14å°æ—¶');
  });

  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "4 days 57 min"', () => {
    expect(formatEstimatedTime('4 days 57 min')).toBe('4å¤©57åˆ†é’Ÿ');
  });

  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "4 days 90 min" (è‡ªåŠ¨è½¬æ¢ä¸ºå°æ—¶)', () => {
    expect(formatEstimatedTime('4 days 90 min')).toBe('4å¤©1å°æ—¶30åˆ†é’Ÿ');
  });

  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "3 days"', () => {
    expect(formatEstimatedTime('3 days')).toBe('3å¤©');
  });

  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "14 hours"', () => {
    expect(formatEstimatedTime('14 hours')).toBe('14å°æ—¶');
  });

  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ– "19 minutes"', () => {
    expect(formatEstimatedTime('19 minutes')).toBe('19åˆ†é’Ÿ');
  });

  it('åº”è¯¥å¤„ç† null/undefined', () => {
    expect(formatEstimatedTime(null)).toBe('è®¡ç®—ä¸­...');
    expect(formatEstimatedTime(undefined)).toBe('è®¡ç®—ä¸­...');
  });
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹

- **æ—§æ ¼å¼ä»ç„¶æ”¯æŒ**: `"14.0 hours"` å’Œ `"19 minutes"` æ ¼å¼ä»ç„¶æœ‰æ•ˆ
- **æ–°æ ¼å¼éœ€è¦è§£æ**: `"5 days 14 hours"` æ ¼å¼éœ€è¦å‰ç«¯æ­£ç¡®è§£æ

### 2. å¤§å°å†™ä¸æ•æ„Ÿ

åç«¯è¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²å¯èƒ½åŒ…å«ï¼š
- `"days"` æˆ– `"day"`ï¼ˆå•å¤æ•°ï¼‰
- `"hours"` æˆ– `"hour"`ï¼ˆå•å¤æ•°ï¼‰
- `"minutes"` æˆ– `"minute"`ï¼ˆå•å¤æ•°ï¼‰

å»ºè®®ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„ `i` æ ‡å¿—ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰è¿›è¡ŒåŒ¹é…ã€‚

### 3. ç©ºå€¼å¤„ç†

`progress_info` æˆ– `estimated_time` å¯èƒ½ä¸º `null` æˆ– `undefined`ï¼Œå‰ç«¯éœ€è¦å¤„ç†è¿™äº›æƒ…å†µã€‚

### 4. å®æ—¶æ›´æ–°

`progress_info` å­—æ®µåœ¨ä»»åŠ¡è¿è¡ŒæœŸé—´ä¼šå®æ—¶æ›´æ–°ï¼Œå‰ç«¯åº”è¯¥ï¼š
- å®šæœŸè½®è¯¢ `GET /api/tasks/{task_id}/detail` æ¥å£
- æˆ–è€…ä½¿ç”¨ WebSocketï¼ˆå¦‚æœå·²å®ç°ï¼‰æ¥æ”¶å®æ—¶æ›´æ–°

---

## ğŸ“Š å®Œæ•´æ¥å£å“åº”ç¤ºä¾‹

```json
{
  "task_id": "c4b6cac4-fd8d-4065-9aa9-6fea71df509e",
  "status": "RUNNING",
  "created_at": 1704067200.0,
  "archive_id": "c4b6cac4-fd8d-4065-9aa9-6fea71df509e",
  "input_dir": "/path/to/inputs/c4b6cac4-fd8d-4065-9aa9-6fea71df509e",
  "output_dir": "/path/to/outputs/c4b6cac4-fd8d-4065-9aa9-6fea71df509e",
  "log_dir": "/path/to/logs/c4b6cac4-fd8d-4065-9aa9-6fea71df509e",
  "params": {
    "job_name": "æµ‹è¯•ä»»åŠ¡",
    "profile_name": "Default",
    "version": "2024R1"
  },
  "download_url": null,
  "download_name": null,
  "display_name": "æµ‹è¯•ä»»åŠ¡-20250104-120000",
  "submitter": "å¼ ä¸‰",
  "duration": null,
  "elapsed_seconds": 3600.0,
  "status_history": [
    {
      "status": "PENDING",
      "timestamp": 1704067200.0
    },
    {
      "status": "STARTED",
      "timestamp": 1704067300.0
    },
    {
      "status": "RUNNING",
      "timestamp": 1704067400.0
    }
  ],
  "parent_task_id": null,
  "retry_count": 0,
  "retried_task_ids": null,
  "progress_info": {
    "estimated_time": "5 days 14 hours",
    "progress_percent": 0.2,
    "current_pass": 1,
    "total_passes": 110,
    "current_sensor": 1,
    "total_sensors": 1
  }
}
```

---

## âœ… æ£€æŸ¥æ¸…å•

å‰ç«¯å¼€å‘äººå‘˜éœ€è¦ç¡®è®¤ï¼š

- [ ] æ›´æ–° `estimated_time` å­—æ®µçš„ç±»å‹å®šä¹‰
- [ ] å®ç°æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼Œæ”¯æŒæ‰€æœ‰æ–°æ ¼å¼
- [ ] æ›´æ–° UI ç»„ä»¶ï¼Œæ­£ç¡®æ˜¾ç¤ºåŒ…å«"å¤©"çš„æ—¶é—´
- [ ] å¤„ç† `null`/`undefined` æƒ…å†µ
- [ ] æµ‹è¯•æ‰€æœ‰æ—¶é—´æ ¼å¼çš„æ˜¾ç¤ºæ•ˆæœ
- [ ] ç¡®ä¿å‘åå…¼å®¹ï¼ˆæ—§æ ¼å¼ä»ç„¶æ­£å¸¸å·¥ä½œï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- åç«¯ä¿®å¤è¯´æ˜: `docs/ä¿®å¤è¯´æ˜_å‰©ä½™æ—¶é—´æ˜¾ç¤ºé—®é¢˜.md`
- API æ¥å£æ–‡æ¡£: `docs/API_DOCUMENTATION.md`ï¼ˆå¦‚æœæœ‰ï¼‰
- ä»»åŠ¡çŠ¶æ€è¯´æ˜: `docs/features/ä»»åŠ¡çŠ¶æ€å®Œæ•´è¯´æ˜.md`

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»åç«¯å¼€å‘å›¢é˜Ÿã€‚

