# 无痕浏览器限制说明

## ⚠️ 重要提示

**断点续传功能不支持无痕浏览器（隐私模式）**

---

## 🔍 问题说明

### 为什么不支持？

断点续传功能依赖 `localStorage` 来保存上传进度，但无痕浏览器对 `localStorage` 有严格的限制：

| 浏览器 | 无痕模式行为 | 影响 |
|--------|------------|------|
| **Chrome 无痕** | localStorage 可用，但关闭标签页后**立即清除** | ❌ 关闭标签页后无法恢复 |
| **Firefox 隐私** | localStorage 可用，但关闭标签页后**立即清除** | ❌ 关闭标签页后无法恢复 |
| **Edge InPrivate** | localStorage 可用，但关闭标签页后**立即清除** | ❌ 关闭标签页后无法恢复 |
| **Safari 隐私** | localStorage **完全禁用** | ❌ 根本无法保存数据 |

### 具体影响

```
标准模式 ✅
  上传文件 → 保存到 localStorage
    ↓
  关闭浏览器
    ↓
  重新打开 → localStorage 数据还在 ✅
    ↓
  继续上传 ✅

无痕模式 ❌
  上传文件 → 保存到 localStorage
    ↓
  关闭标签页
    ↓
  重新打开 → localStorage 数据被清除 ❌
    ↓
  无法继续上传 ❌
```

---

## ✅ 解决方案

### 方案 1：切换到标准浏览器模式（推荐）

**这是唯一的完整解决方案**

1. 关闭无痕窗口
2. 打开标准浏览器窗口
3. 访问网站并上传文件

**优点**：
- ✅ 完全支持断点续传
- ✅ 关闭浏览器后数据保留
- ✅ 随时可以恢复上传

### 方案 2：在同一标签页内操作（临时方案）

**仅适用于短时间内的网络中断**

**操作步骤**：
1. 开始上传
2. 如果网络中断或想暂停
3. **不要关闭标签页**
4. 按 **F5 刷新页面**
5. 应该能看到"未完成上传"提示
6. 继续上传

**限制**：
- ⚠️ 必须保持标签页打开
- ⚠️ 关闭标签页后无法恢复
- ⚠️ 关闭浏览器后无法恢复

### 方案 3：使用小文件避免断点续传

如果必须使用无痕模式，建议：

```
文件大小建议：
- < 10MB → 使用普通上传（不需要断点续传）
- ≥ 10MB → 切换到标准模式

策略：
将大文件拆分成多个小文件（每个 < 10MB）
```

---

## 🧪 如何检测你使用的是否是无痕模式

### 方法 1：视觉检查

**Chrome**：
- 无痕模式：窗口右上角有"👤 无痕"图标，窗口边框是深色
- 标准模式：没有特殊图标，窗口边框是浅色

**Firefox**：
- 无痕模式：窗口右上角有"🔒 紫色面具"图标
- 标准模式：没有特殊图标

**Edge**：
- 无痕模式：窗口右上角有"InPrivate"标识
- 标准模式：没有特殊标识

**Safari**：
- 无痕模式：地址栏是深色，有"隐私浏览"提示
- 标准模式：地址栏是浅色

### 方法 2：代码检测

在浏览器控制台（F12）执行：

```javascript
// 测试 localStorage 持久性
localStorage.setItem('test_persist', Date.now());
console.log('✅ 数据已保存');
console.log('📝 请关闭标签页后重新打开，再次运行以下命令：');
console.log('   const value = localStorage.getItem("test_persist");');
console.log('   console.log("结果:", value);');
console.log('');
console.log('结果判断：');
console.log('- 如果显示时间戳 → 标准模式 ✅');
console.log('- 如果显示 null → 无痕模式 ❌');
```

---

## 📊 功能对比

| 功能 | 标准模式 | 无痕模式 |
|------|---------|---------|
| 断点续传 | ✅ 完全支持 | ❌ 不支持 |
| 关闭标签页后恢复 | ✅ 可以 | ❌ 不可以 |
| 关闭浏览器后恢复 | ✅ 可以 | ❌ 不可以 |
| 同标签页内刷新 | ✅ 可以 | ✅ 可以（临时） |
| 普通上传（< 10MB） | ✅ 支持 | ✅ 支持 |
| 大文件上传（≥ 10MB） | ✅ 推荐 | ⚠️ 不推荐 |

---

## 🎯 使用建议

### 推荐配置

```
上传场景                 浏览器模式          文件大小
─────────────────────────────────────────────
日常使用                 标准模式 ✅         任意大小 ✅
隐私要求高               标准模式 ✅         任意大小 ✅
测试环境                 标准模式 ✅         任意大小 ✅
临时使用                 无痕模式 ⚠️         < 10MB ✅
```

### 不推荐的配置

```
❌ 无痕模式 + 大文件（≥ 10MB）
   → 关闭标签页后无法恢复
   → 浪费已上传的数据

❌ 无痕模式 + 网络不稳定
   → 中断后无法恢复
   → 需要重新上传

❌ Safari 无痕模式 + 任何大小文件
   → localStorage 完全禁用
   → 断点续传无法工作
```

---

## 🔧 技术原因（给开发者）

### localStorage 在无痕模式下的行为

```javascript
// 标准模式
localStorage.setItem('key', 'value');
// → 数据持久化到磁盘
// → 关闭浏览器后保留

// 无痕模式（Chrome/Firefox/Edge）
localStorage.setItem('key', 'value');
// → 数据保存到内存
// → 关闭标签页后清除
// → 关闭浏览器后清除

// 无痕模式（Safari）
localStorage.setItem('key', 'value');
// → 抛出异常或静默失败
// → 根本无法使用
```

### 为什么不用其他存储方案？

**sessionStorage**：
- ❌ 只在单个标签页内有效
- ❌ 刷新页面可以保留，但关闭标签页后清除
- ❌ 无法跨标签页共享
- 结论：比 localStorage 更差

**Cookie**：
- ⚠️ 大小限制 4KB
- ⚠️ 每个请求都会发送（浪费带宽）
- ⚠️ 无痕模式下也会被清除
- 结论：不适合保存上传进度

**IndexedDB**：
- ✅ 容量大
- ✅ 性能好
- ❌ 无痕模式下也会被清除
- ❌ API 复杂
- 结论：有相同的无痕模式限制

**服务器端保存**：
- ✅ 不受浏览器限制
- ✅ 可以跨设备恢复
- ❌ 需要用户登录/认证
- ❌ 增加服务器负担
- ❌ 需要后端开发
- 结论：未来可以考虑

---

## 💡 常见问题

### Q1: 为什么不能检测无痕模式并提示用户？

**A**: 浏览器故意不提供检测无痕模式的 API，因为：
- 保护用户隐私
- 防止网站歧视无痕用户
- 无痕模式应该"看起来"和普通模式一样

我们只能在用户遇到问题后提供说明。

### Q2: 能不能在代码中自动切换策略？

**A**: 可以部分实现：

```typescript
// 检测 localStorage 是否可用
function isLocalStorageAvailable() {
  try {
    const test = '__test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch {
    return false;
  }
}

// 但无法检测数据是否会被清除
// 只能在功能失败后提示用户
```

### Q3: 我就是想用无痕模式怎么办？

**A**: 有两个选择：

**选择 1**（推荐）：
- 只上传小文件（< 10MB）
- 自动使用普通上传，不需要断点续传

**选择 2**（临时方案）：
- 保持标签页打开
- 只在标签页内刷新
- 不要关闭标签页
- 但这样就失去了断点续传的主要价值

---

## 📞 寻求帮助

如果你因为特殊原因必须在无痕模式下使用断点续传，请：

1. **说明具体需求**：为什么必须使用无痕模式？
2. **提供使用场景**：什么情况下需要上传大文件？
3. **评估替代方案**：是否可以接受其他方案？

我们可以评估是否需要实现服务器端保存进度的功能。

---

## 🎓 总结

**一句话总结**：
> 断点续传功能需要在**标准浏览器模式**下使用，无痕模式不支持。

**快速决策**：
```
你是否在使用无痕模式？
  ├─ 是 → 切换到标准模式 ✅
  └─ 否 → 可以正常使用断点续传 ✅

你必须使用无痕模式？
  ├─ 是 → 只上传小文件（< 10MB）✅
  └─ 否 → 切换到标准模式 ✅
```

---

**记住**：标准浏览器模式同样保护你的隐私，只是不会在关闭后立即清除所有数据。如果你担心隐私，可以定期手动清除浏览器数据。

