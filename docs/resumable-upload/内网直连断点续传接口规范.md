# å†…ç½‘ç›´è¿æ¨¡å¼æ–­ç‚¹ç»­ä¼ æ¥å£è§„èŒƒ

**æ¨¡å¼**: å†…ç½‘ç›´è¿ï¼ˆDirect Uploadï¼‰  
**å‰ç¼€**: `/api/upload/direct/multipart`  
**çŠ¶æ€**: âœ… å·²å®ç°

---

## ğŸ“‹ æ¥å£æ¸…å•

| åºå· | æ¥å£è·¯å¾„ | æ–¹æ³• | ç”¨é€” | å¿…é¡» |
|------|---------|------|------|------|
| 1 | `/api/upload/direct/multipart/init` | POST | åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼  | â­ å¿…é¡» |
| 2 | `/api/upload/direct/multipart/part` | POST | ä¸Šä¼ å•ä¸ªåˆ†ç‰‡ | â­ å¿…é¡» |
| 3 | `/api/upload/direct/multipart/list` | POST | æŸ¥è¯¢å·²ä¸Šä¼ åˆ†ç‰‡ï¼ˆæ–­ç‚¹ç»­ä¼ å…³é”®ï¼‰ | â­ å¿…é¡» |
| 4 | `/api/upload/direct/multipart/complete` | POST | å®Œæˆä¸Šä¼ å¹¶åˆå¹¶ | â­ å¿…é¡» |
| 5 | `/api/upload/direct/multipart/abort` | POST | å–æ¶ˆä¸Šä¼  | âšª å¯é€‰ |

---

## 1ï¸âƒ£ åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 

**æ¥å£**: `POST /api/upload/direct/multipart/init`

**è¯·æ±‚ä½“**:
```json
{
  "filename": "model.zip",
  "file_size": 524288000,
  "file_type": "master",
  "content_type": "application/octet-stream",
  "chunk_size": 5242880,
  "task_id": "å¯é€‰ï¼Œå¤ç”¨å·²æœ‰ä»»åŠ¡ID",
  "job_name": "å¯é€‰",
  "submitter": "å¯é€‰"
}
```

**å“åº”**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "filename": "model.zip",
  "chunk_size": 5242880,
  "total_chunks": 100,
  "parts": [
    {
      "part_number": 1,
      "start_byte": 0,
      "end_byte": 5242880,
      "size": 5242880
    }
  ],
  "message": "..."
}
```

**å…³é”®å­—æ®µ**:
- `task_id`: åç»­æ‰€æœ‰æ¥å£éƒ½éœ€è¦
- `upload_id`: å”¯ä¸€æ ‡è¯†æœ¬æ¬¡ä¸Šä¼ ä¼šè¯ï¼Œåç»­æ‰€æœ‰æ¥å£éƒ½éœ€è¦
- `total_chunks`: æ€»åˆ†ç‰‡æ•°
- `parts`: æ‰€æœ‰åˆ†ç‰‡çš„å­—èŠ‚èŒƒå›´ä¿¡æ¯

**æ–‡ä»¶ç±»å‹é™åˆ¶**:
- `file_type`: å¿…é¡»æ˜¯ `"master"` æˆ– `"include"`
- **includeæ–‡ä»¶å¿…é¡»æ˜¯å‹ç¼©åŒ…æ ¼å¼**ï¼š`.zip`, `.rar`, `.7z`, `.tar`, `.gz`, `.tar.gz`
- å¦‚æœ `file_type="include"` ä½†æ–‡ä»¶åä¸æ˜¯å‹ç¼©åŒ…æ ¼å¼ï¼Œä¼šè¿”å›400é”™è¯¯

---

## 2ï¸âƒ£ ä¸Šä¼ å•ä¸ªåˆ†ç‰‡

**æ¥å£**: `POST /api/upload/direct/multipart/part`

**è¯·æ±‚æ–¹å¼**: `multipart/form-data`

**è¡¨å•å­—æ®µ**:
- `task_id`: stringï¼ˆå¿…é¡»ï¼‰
- `upload_id`: stringï¼ˆå¿…é¡»ï¼‰
- `part_number`: intï¼ˆå¿…é¡»ï¼Œä»1å¼€å§‹ï¼‰
- `file`: Fileï¼ˆå¿…é¡»ï¼Œåˆ†ç‰‡æ•°æ®ï¼‰

**å“åº”**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "part_number": 1,
  "size": 5242880,
  "md5": "abc123...",
  "message": "Part 1/100 uploaded successfully"
}
```

**é‡è¦è¯´æ˜**:
- åˆ†ç‰‡ç¼–å·ä» **1** å¼€å§‹ï¼Œä¸æ˜¯0
- åˆ†ç‰‡æ–‡ä»¶åæ ¼å¼ï¼š`part_00001`, `part_00002`, ...ï¼ˆ5ä½æ•°å­—ï¼Œå‰é¢è¡¥0ï¼‰
- å¯ä»¥é‡å¤ä¸Šä¼ åŒä¸€åˆ†ç‰‡ï¼ˆä¼šè¦†ç›–ï¼‰
- è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯ `multipart/form-data`ï¼Œä¸æ˜¯ JSON

---

## 3ï¸âƒ£ æŸ¥è¯¢å·²ä¸Šä¼ åˆ†ç‰‡ï¼ˆæ–­ç‚¹ç»­ä¼ å…³é”®ï¼‰

**æ¥å£**: `POST /api/upload/direct/multipart/list`

**è¯·æ±‚ä½“**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz"
}
```

**å“åº”**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "parts": [1, 2, 3, 5, 7],
  "message": "Found 5 uploaded parts"
}
```

**å…³é”®è¯´æ˜**:
- `parts`: è¿”å›å·²ä¸Šä¼ çš„åˆ†ç‰‡ç¼–å·åˆ—è¡¨ï¼ˆæ•´æ•°æ•°ç»„ï¼‰
- **æ–­ç‚¹ç»­ä¼ æµç¨‹**ï¼šå‰ç«¯è°ƒç”¨æ­¤æ¥å£ï¼Œè·å–å·²ä¸Šä¼ åˆ†ç‰‡ï¼Œè·³è¿‡è¿™äº›åˆ†ç‰‡ï¼Œåªä¸Šä¼ ç¼ºå¤±çš„åˆ†ç‰‡

---

## 4ï¸âƒ£ å®Œæˆä¸Šä¼ å¹¶åˆå¹¶

**æ¥å£**: `POST /api/upload/direct/multipart/complete`

**è¯·æ±‚ä½“**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz",
  "filename": "model.zip",
  "file_type": "master",
  "parts": [
    {"part_number": 1},
    {"part_number": 2}
  ]
}
```

**å“åº”**:
```json
{
  "task_id": "abc-123",
  "filename": "model.zip",
  "file_path": "/path/to/final/file",
  "file_size": 524288000,
  "status": "completed",
  "message": "All 100 parts uploaded and merged successfully"
}
```

**å…³é”®è¯´æ˜**:
- `parts` å­—æ®µï¼š**å¯é€‰**ï¼Œä½†å»ºè®®ä¼ é€’å·²ä¸Šä¼ çš„åˆ†ç‰‡åˆ—è¡¨ï¼ˆåªåŒ…å« `part_number` å³å¯ï¼‰
- **åç«¯ä¼šæ‰«æå®é™…å­˜åœ¨çš„åˆ†ç‰‡æ–‡ä»¶**ï¼ˆæ ¼å¼ï¼š`part_00001`, `part_00002`...ï¼‰ï¼Œå³ä½¿å‰ç«¯ä¼ é€’çš„åˆ—è¡¨ä¸å®Œæ•´ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
- åç«¯ä¼šéªŒè¯æ‰€æœ‰åˆ†ç‰‡ï¼ˆ1åˆ°total_chunksï¼‰éƒ½å­˜åœ¨ï¼Œç¼ºå¤±ä¼šè¿”å›400é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ä¼šåˆ—å‡ºç¼ºå¤±çš„åˆ†ç‰‡ç¼–å·
- åˆå¹¶å®Œæˆåï¼Œä¸´æ—¶åˆ†ç‰‡æ–‡ä»¶ä¼šè¢«æ¸…ç†
- åˆå¹¶æ—¶æŒ‰åˆ†ç‰‡ç¼–å·é¡ºåºï¼ˆ1, 2, 3...ï¼‰åˆå¹¶

---

## 5ï¸âƒ£ å–æ¶ˆä¸Šä¼ ï¼ˆå¯é€‰ï¼‰

**æ¥å£**: `POST /api/upload/direct/multipart/abort`

**è¯·æ±‚ä½“**:
```json
{
  "task_id": "abc-123",
  "upload_id": "upload-xyz"
}
```

**å“åº”**:
```json
{
  "message": "Multipart upload aborted successfully",
  "task_id": "abc-123",
  "upload_id": "upload-xyz"
}
```

---

## ğŸ”„ æ–­ç‚¹ç»­ä¼ å®Œæ•´æµç¨‹

### é¦–æ¬¡ä¸Šä¼ æµç¨‹ï¼š
1. è°ƒç”¨ `init` â†’ è·å– `task_id`, `upload_id`, `total_chunks`, `parts`
2. **ä¿å­˜ä¼šè¯ä¿¡æ¯**ï¼š`task_id`, `upload_id`, `total_chunks` ç­‰ï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰
3. éå†æ‰€æœ‰åˆ†ç‰‡ï¼ˆ1åˆ°total_chunksï¼‰ï¼Œè°ƒç”¨ `part` ä¸Šä¼ æ¯ä¸ªåˆ†ç‰‡
4. æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè°ƒç”¨ `complete` åˆå¹¶æ–‡ä»¶

### æ–­ç‚¹ç»­ä¼ æµç¨‹ï¼š
1. **æ¢å¤ä¼šè¯**ï¼šä½¿ç”¨ä¹‹å‰ä¿å­˜çš„ `task_id` å’Œ `upload_id`
2. è°ƒç”¨ `list` â†’ è·å–å·²ä¸Šä¼ çš„åˆ†ç‰‡åˆ—è¡¨ï¼Œå¦‚ `[1, 2, 3, 5]`
3. è®¡ç®—ç¼ºå¤±åˆ†ç‰‡ï¼š
   ```javascript
   const allParts = Array.from({length: total_chunks}, (_, i) => i + 1); // [1, 2, 3, ..., 100]
   const uploadedParts = [1, 2, 3, 5]; // ä»listæ¥å£è·å–
   const missingParts = allParts.filter(p => !uploadedParts.includes(p)); // [4, 6, 7, ..., 100]
   ```
4. åªä¸Šä¼ ç¼ºå¤±çš„åˆ†ç‰‡ï¼ˆè°ƒç”¨ `part`ï¼‰
5. æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆåï¼Œè°ƒç”¨ `complete` åˆå¹¶æ–‡ä»¶

### é”™è¯¯å¤„ç†ï¼š
- **initå¤±è´¥**ï¼šå¯èƒ½æ˜¯æ–‡ä»¶å¤§å°è¶…é™ã€æ–‡ä»¶ç±»å‹é”™è¯¯ç­‰ï¼Œæ£€æŸ¥é”™è¯¯ä¿¡æ¯
- **partä¸Šä¼ å¤±è´¥**ï¼šå¯ä»¥é‡è¯•ï¼Œä¼šè¦†ç›–å·²ä¸Šä¼ çš„åˆ†ç‰‡
- **listè¿”å›404**ï¼šè¯´æ˜ä¼šè¯ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°init
- **completeè¿”å›400**ï¼šè¯´æ˜æœ‰åˆ†ç‰‡ç¼ºå¤±ï¼Œé”™è¯¯ä¿¡æ¯ä¼šåˆ—å‡ºç¼ºå¤±çš„åˆ†ç‰‡ç¼–å·ï¼Œéœ€è¦è¡¥ä¼ 

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

1. **åˆ†ç‰‡ç¼–å·ä»1å¼€å§‹**ï¼Œä¸æ˜¯0
2. **task_id å’Œ upload_id å¿…é¡»ä¿å­˜**ï¼Œç”¨äºæ–­ç‚¹ç»­ä¼ 
3. **åˆ†ç‰‡æ–‡ä»¶åæ ¼å¼**ï¼š`part_00001`, `part_00002`ï¼ˆ5ä½æ•°å­—ï¼Œå‰é¢è¡¥0ï¼‰
4. **completeæ¥å£çš„partså­—æ®µæ˜¯å¯é€‰çš„**ï¼Œä½†å»ºè®®ä¼ é€’ï¼Œåç«¯ä¼šåŸºäºå®é™…æ–‡ä»¶éªŒè¯
5. **åç«¯ä¼šæ‰«æå®é™…å­˜åœ¨çš„åˆ†ç‰‡æ–‡ä»¶**ï¼Œä¸å®Œå…¨ä¾èµ–å‰ç«¯ä¼ é€’çš„åˆ—è¡¨
6. **æ‰€æœ‰åˆ†ç‰‡å¿…é¡»å­˜åœ¨æ‰èƒ½complete**ï¼Œç¼ºå¤±ä¼šè¿”å›400é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯æ ¼å¼ï¼š`"Missing parts: [4, 5, 6]. Please upload all parts before completing. Found 97/100 parts on server."`
7. **ä¸Šä¼ åˆ†ç‰‡æ¥å£ä½¿ç”¨multipart/form-data**ï¼Œä¸æ˜¯JSON
8. **listæ¥å£è¿”å›çš„æ˜¯æ•´æ•°æ•°ç»„**ï¼Œå¦‚ `[1, 2, 3, 5]`ï¼Œè¡¨ç¤ºå·²ä¸Šä¼ çš„åˆ†ç‰‡ç¼–å·

---

## ğŸ“ å‰ç«¯éœ€è¦ä¿å­˜çš„ä¿¡æ¯

ä¸ºäº†æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå‰ç«¯éœ€è¦ä¿å­˜ï¼š
```javascript
{
  task_id: "abc-123",
  upload_id: "upload-xyz",
  filename: "model.zip",
  file_size: 524288000,
  total_chunks: 100,
  chunk_size: 5242880,
  file_type: "master"
}
```

å»ºè®®ä½¿ç”¨ `localStorage` æˆ– `sessionStorage` ä¿å­˜ã€‚

---

## ğŸ“Š æ¥å£å¿«é€Ÿå‚è€ƒè¡¨

| æ¥å£ | æ–¹æ³• | è¯·æ±‚æ ¼å¼ | å…³é”®å‚æ•° | å…³é”®è¿”å› |
|------|------|---------|---------|---------|
| `/api/upload/direct/multipart/init` | POST | JSON | `filename`, `file_size`, `file_type`, `chunk_size` | `task_id`, `upload_id`, `total_chunks`, `parts[]` |
| `/api/upload/direct/multipart/part` | POST | multipart/form-data | `task_id`, `upload_id`, `part_number`, `file` | `part_number`, `size`, `md5` |
| `/api/upload/direct/multipart/list` | POST | JSON | `task_id`, `upload_id` | `parts[]` (æ•´æ•°æ•°ç»„) |
| `/api/upload/direct/multipart/complete` | POST | JSON | `task_id`, `upload_id`, `filename`, `parts[]` (å¯é€‰) | `file_path`, `file_size`, `status` |
| `/api/upload/direct/multipart/abort` | POST | JSON | `task_id`, `upload_id` | `message` |

---

## âœ… å‰ç«¯å¯¹é½æ£€æŸ¥æ¸…å•

è¯·å‰ç«¯ç¡®è®¤ä»¥ä¸‹å…³é”®ç‚¹ï¼š

- [ ] **åˆ†ç‰‡ç¼–å·ä»1å¼€å§‹**ï¼Œä¸æ˜¯0
- [ ] **initæ¥å£**ï¼šæ­£ç¡®ä¼ é€’ `filename`, `file_size`, `file_type`, `chunk_size`
- [ ] **partæ¥å£**ï¼šä½¿ç”¨ `multipart/form-data`ï¼Œä¸æ˜¯JSONï¼Œæ­£ç¡®ä¼ é€’ `task_id`, `upload_id`, `part_number`, `file`
- [ ] **listæ¥å£**ï¼šæ­£ç¡®ä¼ é€’ `task_id`, `upload_id`ï¼Œç†è§£è¿”å›çš„ `parts` æ˜¯æ•´æ•°æ•°ç»„
- [ ] **completeæ¥å£**ï¼š`parts` å­—æ®µå¯é€‰ï¼Œä½†å»ºè®®ä¼ é€’ï¼Œæ ¼å¼ä¸º `[{"part_number": 1}, {"part_number": 2}]`
- [ ] **ä¿å­˜ä¼šè¯ä¿¡æ¯**ï¼š`task_id`, `upload_id`, `total_chunks` ç­‰å¿…é¡»ä¿å­˜
- [ ] **æ–­ç‚¹ç»­ä¼ é€»è¾‘**ï¼šå…ˆè°ƒç”¨ `list` è·å–å·²ä¸Šä¼ åˆ†ç‰‡ï¼Œè®¡ç®—ç¼ºå¤±åˆ†ç‰‡ï¼Œåªä¸Šä¼ ç¼ºå¤±çš„
- [ ] **é”™è¯¯å¤„ç†**ï¼šæ­£ç¡®å¤„ç†400é”™è¯¯ï¼ˆç¼ºå¤±åˆ†ç‰‡ï¼‰ã€404é”™è¯¯ï¼ˆä¼šè¯ä¸å­˜åœ¨ï¼‰ç­‰

