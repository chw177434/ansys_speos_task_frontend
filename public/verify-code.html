<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰ç«¯ä»£ç éªŒè¯å·¥å…·</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1e40af;
      margin-top: 0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .success {
      background: #f0fdf4;
      border-left-color: #22c55e;
    }
    .error {
      background: #fef2f2;
      border-left-color: #ef4444;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    .result {
      margin-top: 10px;
      font-family: monospace;
      font-size: 14px;
    }
    .icon {
      font-size: 20px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” å‰ç«¯ä»£ç æ›´æ–°éªŒè¯å·¥å…·</h1>
    <p>ä½¿ç”¨æ­¤å·¥å…·å¿«é€ŸéªŒè¯å‰ç«¯ä»£ç æ˜¯å¦å·²ç”Ÿæ•ˆ</p>

    <div class="section">
      <h3><span class="icon">ğŸš€</span>æ­¥éª¤ 1: æ£€æŸ¥ Network è¯·æ±‚</h3>
      <p>ç‚¹å‡»æŒ‰é’®ååˆ·æ–°ä¸»é¡µé¢ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ /detail è¯·æ±‚</p>
      <button onclick="checkDetailRequests()">æ£€æŸ¥ Detail è¯·æ±‚</button>
      <div id="result1" class="result"></div>
    </div>

    <div class="section">
      <h3><span class="icon">ğŸ“¡</span>æ­¥éª¤ 2: æµ‹è¯• API è°ƒç”¨</h3>
      <p>æ‰‹åŠ¨è°ƒç”¨ä¸€ä¸ªè¿è¡Œä¸­ä»»åŠ¡çš„ detail æ¥å£</p>
      <input type="text" id="taskId" placeholder="è¾“å…¥ä»»åŠ¡ ID" style="width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      <button onclick="testDetailApi()">æµ‹è¯• Detail API</button>
      <div id="result2" class="result"></div>
    </div>

    <div class="section">
      <h3><span class="icon">ğŸ”</span>æ­¥éª¤ 3: æ£€æŸ¥ DOM ç»“æ„</h3>
      <p>æ£€æŸ¥é¡µé¢ä¸­æ˜¯å¦æœ‰è¿›åº¦ä¿¡æ¯çš„ DOM å…ƒç´ </p>
      <button onclick="checkProgressCards()">æ£€æŸ¥è¿›åº¦å¡ç‰‡</button>
      <div id="result3" class="result"></div>
    </div>

    <div class="section">
      <h3><span class="icon">ğŸ“Š</span>æ­¥éª¤ 4: æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡çŠ¶æ€</h3>
      <p>è·å–ä»»åŠ¡åˆ—è¡¨å¹¶æ£€æŸ¥ progress_info å­—æ®µ</p>
      <button onclick="checkTaskList()">æ£€æŸ¥ä»»åŠ¡åˆ—è¡¨</button>
      <div id="result4" class="result"></div>
    </div>

    <div class="section">
      <h3><span class="icon">ğŸ¯</span>å®Œæ•´è¯Šæ–­</h3>
      <p>è¿è¡Œæ‰€æœ‰æ£€æŸ¥ï¼Œç”Ÿæˆå®Œæ•´æŠ¥å‘Š</p>
      <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
      <div id="resultFull" class="result"></div>
    </div>
  </div>

  <script>
    function checkDetailRequests() {
      const result = document.getElementById('result1');
      result.innerHTML = '<p style="color: #3b82f6;">æ­£åœ¨æ£€æŸ¥...</p>';
      
      setTimeout(() => {
        const resources = performance.getEntriesByType('resource');
        const detailRequests = resources.filter(r => r.name.includes('/detail'));
        
        let html = '<pre>';
        html += '=== Network è¯·æ±‚åˆ†æ ===\n\n';
        html += `æ€»è¯·æ±‚æ•°: ${resources.length}\n`;
        html += `åŒ…å« /detail çš„è¯·æ±‚: ${detailRequests.length}\n\n`;
        
        if (detailRequests.length > 0) {
          html += 'âœ… æ‰¾åˆ° /detail è¯·æ±‚ï¼š\n\n';
          detailRequests.forEach((r, i) => {
            html += `${i + 1}. ${r.name}\n`;
            html += `   è€—æ—¶: ${r.duration.toFixed(2)}ms\n\n`;
          });
          html += '\nâœ… ä»£ç å·²ç”Ÿæ•ˆï¼';
        } else {
          html += 'âŒ æ²¡æœ‰æ‰¾åˆ° /detail è¯·æ±‚\n\n';
          html += 'å¯èƒ½åŸå› ï¼š\n';
          html += '1. æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆPROGRESS/RUNNING/STARTEDï¼‰\n';
          html += '2. ä»£ç è¿˜æ²¡ç”Ÿæ•ˆï¼Œéœ€è¦ç¡¬åˆ·æ–°ï¼ˆCtrl+Shift+Rï¼‰\n';
          html += '3. æµè§ˆå™¨ç¼“å­˜ï¼Œè¯·åœ¨ Network é€‰é¡¹å¡å‹¾é€‰ Disable cache\n';
        }
        html += '</pre>';
        
        result.innerHTML = html;
      }, 100);
    }

    async function testDetailApi() {
      const result = document.getElementById('result2');
      const taskId = document.getElementById('taskId').value.trim();
      
      if (!taskId) {
        result.innerHTML = '<p style="color: #ef4444;">è¯·è¾“å…¥ä»»åŠ¡ ID</p>';
        return;
      }
      
      result.innerHTML = '<p style="color: #3b82f6;">æ­£åœ¨è¯·æ±‚...</p>';
      
      try {
        const response = await fetch(`/api/tasks/${taskId}/detail`);
        const data = await response.json();
        
        let html = '<pre>';
        html += '=== Detail API å“åº” ===\n\n';
        html += `Task ID: ${data.task_id}\n`;
        html += `Status: ${data.status}\n`;
        html += `Elapsed: ${data.elapsed_seconds?.toFixed(1) || 'N/A'} ç§’\n\n`;
        
        if (data.progress_info) {
          html += 'âœ… Progress Info å­˜åœ¨ï¼š\n\n';
          html += JSON.stringify(data.progress_info, null, 2);
        } else {
          html += 'âŒ Progress Info ä¸º null\n';
          html += 'è¯´æ˜åç«¯è¿˜æ²¡æœ‰æ•è·åˆ°è¿›åº¦ä¿¡æ¯';
        }
        html += '</pre>';
        
        result.innerHTML = html;
      } catch (error) {
        result.innerHTML = `<pre style="color: #ef4444;">âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}</pre>`;
      }
    }

    function checkProgressCards() {
      const result = document.getElementById('result3');
      result.innerHTML = '<p style="color: #3b82f6;">æ­£åœ¨æ£€æŸ¥...</p>';
      
      setTimeout(() => {
        // æ£€æŸ¥å¤šç§å¯èƒ½çš„è¿›åº¦å¡ç‰‡ç‰¹å¾
        const selectors = [
          '[class*="from-blue-50"]',
          '[class*="to-indigo-50"]',
          '.bg-gradient-to-br',
          'div:has(.text-blue-900):has(.font-semibold)'
        ];
        
        let found = false;
        let html = '<pre>';
        html += '=== DOM ç»“æ„æ£€æŸ¥ ===\n\n';
        
        selectors.forEach(selector => {
          try {
            const elements = document.querySelectorAll(selector);
            if (elements.length > 0) {
              html += `âœ… æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ : ${selector}\n`;
              found = true;
            }
          } catch (e) {
            // æŸäº›é€‰æ‹©å™¨å¯èƒ½ä¸æ”¯æŒ
          }
        });
        
        if (found) {
          html += '\nâœ… æ‰¾åˆ°äº†è¿›åº¦ç›¸å…³çš„ DOM å…ƒç´ ï¼\n';
          html += 'å¦‚æœç•Œé¢ä¸Šçœ‹ä¸åˆ°ï¼Œå¯èƒ½æ˜¯ CSS é—®é¢˜';
        } else {
          html += 'âŒ æ²¡æœ‰æ‰¾åˆ°è¿›åº¦ç›¸å…³çš„ DOM å…ƒç´ \n\n';
          html += 'å¯èƒ½åŸå› ï¼š\n';
          html += '1. æ²¡æœ‰ progress_info æ•°æ®\n';
          html += '2. æ¸²æŸ“å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨\n';
          html += '3. ä»£ç è¿˜æ²¡ç”Ÿæ•ˆ';
        }
        html += '</pre>';
        
        result.innerHTML = html;
      }, 100);
    }

    async function checkTaskList() {
      const result = document.getElementById('result4');
      result.innerHTML = '<p style="color: #3b82f6;">æ­£åœ¨è·å–ä»»åŠ¡åˆ—è¡¨...</p>';
      
      try {
        const response = await fetch('/api/tasks');
        const data = await response.json();
        
        const items = Array.isArray(data) ? data : data.items || [];
        const runningTasks = items.filter(t => 
          ['RUNNING', 'PROGRESS', 'STARTED'].includes(t.status)
        );
        
        let html = '<pre>';
        html += '=== ä»»åŠ¡åˆ—è¡¨åˆ†æ ===\n\n';
        html += `æ€»ä»»åŠ¡æ•°: ${items.length}\n`;
        html += `è¿è¡Œä¸­ä»»åŠ¡: ${runningTasks.length}\n\n`;
        
        if (runningTasks.length > 0) {
          html += 'è¿è¡Œä¸­çš„ä»»åŠ¡ï¼š\n\n';
          runningTasks.forEach((task, i) => {
            html += `${i + 1}. ${task.task_id}\n`;
            html += `   çŠ¶æ€: ${task.status}\n`;
            html += `   ä»»åŠ¡å: ${task.job_name || 'N/A'}\n`;
            html += `   progress_info: ${task.progress_info ? 'âœ… å­˜åœ¨' : 'âŒ null/ä¸å­˜åœ¨'}\n`;
            
            if (task.progress_info) {
              html += `   â””â”€ æ•°æ®: ${JSON.stringify(task.progress_info)}\n`;
            }
            html += '\n';
          });
          
          // æ£€æŸ¥åˆ—è¡¨æ¥å£æ˜¯å¦è¿”å›äº† progress_info
          const hasProgressInList = runningTasks.some(t => t.progress_info);
          if (hasProgressInList) {
            html += '\nâœ… åˆ—è¡¨æ¥å£å·²åŒ…å« progress_infoï¼\n';
            html += 'å‰ç«¯åº”è¯¥èƒ½ç›´æ¥æ˜¾ç¤ºï¼Œæ— éœ€é¢å¤–è¯·æ±‚ã€‚\n';
          } else {
            html += '\nâš ï¸  åˆ—è¡¨æ¥å£ä¸åŒ…å« progress_info\n';
            html += 'å‰ç«¯éœ€è¦é¢å¤–è°ƒç”¨ detail æ¥å£è·å–ã€‚\n';
          }
        } else {
          html += 'âš ï¸  å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡\n';
          html += 'æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡æ¥æµ‹è¯•åŠŸèƒ½';
        }
        
        html += '</pre>';
        result.innerHTML = html;
      } catch (error) {
        result.innerHTML = `<pre style="color: #ef4444;">âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}</pre>`;
      }
    }

    async function runFullDiagnostic() {
      const result = document.getElementById('resultFull');
      result.innerHTML = '<p style="color: #3b82f6;">æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...</p>';
      
      let html = '<pre>';
      html += '========================================\n';
      html += '       å‰ç«¯ä»£ç æ›´æ–°å®Œæ•´è¯Šæ–­æŠ¥å‘Š\n';
      html += '========================================\n\n';
      
      // 1. æ£€æŸ¥ Network è¯·æ±‚
      html += '1ï¸âƒ£ Network è¯·æ±‚æ£€æŸ¥\n';
      html += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
      const resources = performance.getEntriesByType('resource');
      const detailRequests = resources.filter(r => r.name.includes('/detail'));
      const outputRequests = resources.filter(r => r.name.includes('/outputs'));
      
      html += `æ€»è¯·æ±‚æ•°: ${resources.length}\n`;
      html += `Detail è¯·æ±‚: ${detailRequests.length}\n`;
      html += `Output è¯·æ±‚: ${outputRequests.length}\n`;
      
      if (detailRequests.length > 0) {
        html += '\nâœ… æ‰¾åˆ° Detail è¯·æ±‚ï¼ˆä»£ç å·²ç”Ÿæ•ˆï¼‰\n';
        detailRequests.forEach(r => {
          html += `   ${r.name}\n`;
        });
      } else {
        html += '\nâŒ æ²¡æœ‰ Detail è¯·æ±‚ï¼ˆä»£ç æœªç”Ÿæ•ˆæˆ–æ— è¿è¡Œä¸­ä»»åŠ¡ï¼‰\n';
      }
      html += '\n';
      
      // 2. æ£€æŸ¥ä»»åŠ¡åˆ—è¡¨
      html += '2ï¸âƒ£ ä»»åŠ¡åˆ—è¡¨æ£€æŸ¥\n';
      html += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
      
      try {
        const response = await fetch('/api/tasks');
        const data = await response.json();
        const items = Array.isArray(data) ? data : data.items || [];
        const runningTasks = items.filter(t => 
          ['RUNNING', 'PROGRESS', 'STARTED'].includes(t.status)
        );
        
        html += `æ€»ä»»åŠ¡æ•°: ${items.length}\n`;
        html += `è¿è¡Œä¸­ä»»åŠ¡: ${runningTasks.length}\n\n`;
        
        if (runningTasks.length > 0) {
          runningTasks.forEach((task, i) => {
            html += `ä»»åŠ¡ ${i + 1}:\n`;
            html += `  ID: ${task.task_id}\n`;
            html += `  çŠ¶æ€: ${task.status}\n`;
            html += `  progress_info: ${task.progress_info ? 'âœ… å­˜åœ¨' : 'âŒ null'}\n\n`;
          });
        } else {
          html += 'âš ï¸  æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡\n\n';
        }
      } catch (error) {
        html += `âŒ è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${error.message}\n\n`;
      }
      
      // 3. æ£€æŸ¥ DOM
      html += '3ï¸âƒ£ DOM ç»“æ„æ£€æŸ¥\n';
      html += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
      const progressCards = document.querySelectorAll('[class*="from-blue-50"]');
      html += `è¿›åº¦å¡ç‰‡æ•°é‡: ${progressCards.length}\n`;
      
      if (progressCards.length > 0) {
        html += 'âœ… æ‰¾åˆ°è¿›åº¦å¡ç‰‡ DOM å…ƒç´ \n';
        progressCards.forEach((card, i) => {
          const visible = card.offsetParent !== null;
          html += `  å¡ç‰‡ ${i + 1}: ${visible ? 'âœ… å¯è§' : 'âŒ éšè—'}\n`;
        });
      } else {
        html += 'âŒ æ²¡æœ‰æ‰¾åˆ°è¿›åº¦å¡ç‰‡ DOM å…ƒç´ \n';
      }
      html += '\n';
      
      // 4. æ€»ç»“
      html += '========================================\n';
      html += '            è¯Šæ–­ç»“æœ\n';
      html += '========================================\n\n';
      
      const codeWorking = detailRequests.length > 0;
      const hasRunningTasks = runningTasks && runningTasks.length > 0;
      const hasDom = progressCards.length > 0;
      
      if (codeWorking && hasDom) {
        html += 'âœ… ä»£ç å·²ç”Ÿæ•ˆï¼Œè¿›åº¦ä¿¡æ¯åº”è¯¥å¯è§\n';
        html += '\nå¦‚æœç•Œé¢ä¸Šçœ‹ä¸åˆ°ï¼Œè¯·æ£€æŸ¥ï¼š\n';
        html += '- æ»šåŠ¨é¡µé¢åˆ°æ­£ç¡®ä½ç½®\n';
        html += '- ä»»åŠ¡çŠ¶æ€æ˜¯å¦çœŸçš„æ˜¯è¿è¡Œä¸­\n';
        html += '- progress_info æ˜¯å¦æœ‰æ•°æ®\n';
      } else if (!codeWorking) {
        html += 'âŒ ä»£ç è¿˜æ²¡ç”Ÿæ•ˆï¼\n\n';
        html += 'è¯·æ‰§è¡Œï¼š\n';
        html += '1. åœ¨æœåŠ¡å™¨ä¸Šï¼š./cleanup-and-restart.sh\n';
        html += '2. åœ¨æµè§ˆå™¨ä¸­ï¼šæŒ‰ Ctrl+Shift+R ç¡¬åˆ·æ–°\n';
        html += '3. Network é€‰é¡¹å¡ï¼šå‹¾é€‰ Disable cache\n';
      } else if (!hasRunningTasks) {
        html += 'âš ï¸  ä»£ç å¯èƒ½å·²ç”Ÿæ•ˆï¼Œä½†æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡\n\n';
        html += 'è¯·æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡æ¥æµ‹è¯•è¿›åº¦æ˜¾ç¤ºåŠŸèƒ½\n';
      } else {
        html += 'âš ï¸  éƒ¨åˆ†åŠŸèƒ½æ­£å¸¸ï¼Œéœ€è¦è¿›ä¸€æ­¥æ’æŸ¥\n';
      }
      
      html += '</pre>';
      result.innerHTML = html;
    }

    // é¡µé¢åŠ è½½æ—¶çš„æç¤º
    window.addEventListener('load', () => {
      console.log('%cğŸ” å‰ç«¯ä»£ç éªŒè¯å·¥å…·å·²åŠ è½½', 'color: #3b82f6; font-size: 16px; font-weight: bold;');
      console.log('è¯·ä½¿ç”¨é¡µé¢ä¸Šçš„æŒ‰é’®è¿›è¡Œè¯Šæ–­ï¼Œæˆ–ç›´æ¥è¿è¡Œ runFullDiagnostic()');
    });
  </script>
</body>
</html>

